<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="/iframe/assets/jszip.min.js"></script>
		<script src="/iframe/assets/pdf.min.js"></script>
		<title>ç¬¦å·æå–åŠ©æ‰‹</title>
		<style>
			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				margin: 0;
				padding: 0;
				background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
				height: 100vh;
				overflow: hidden;
				color: #495057;
			}
			.container {
				display: flex;
				height: 100vh;
				background-color: #ffffff;
				box-shadow: 0 0 20px rgba(0,0,0,0.1);
			}
			.header {
				display: none;
			}
			h1 {
				margin: 0;
				font-size: 20px;
				font-weight: 600;
				color: #343a40;
				letter-spacing: -0.5px;
			}
			.settings-btn {
				background: #e3f2fd;
				color: #1976d2;
				border: 1px solid #bbdefb;
				border-radius: 4px;
				padding: 0 16px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 400;
				transition: background-color 0.2s ease;
				display: flex;
				align-items: center;
				gap: 6px;
				height: 24px;
				line-height: 24px;
				min-width: 24px;
			}
			.settings-btn:hover {
				background: #bbdefb;
			}
			.settings-modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				z-index: 1000;
				align-items: center;
				justify-content: center;
			}
			.settings-content {
				background: white;
				border-radius: 12px;
				padding: 24px;
				width: 400px;
				max-width: 90vw;
				box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			}
			.settings-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}
			.settings-title {
				font-size: 18px;
				font-weight: 600;
				color: #343a40;
				margin: 0;
			}
			.close-btn {
				background: none;
				border: none;
				font-size: 24px;
				cursor: pointer;
				color: #6c757d;
				padding: 0;
				width: 24px;
				height: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 6px;
				transition: all 0.2s ease;
				line-height: 24px;
				min-width: 24px;
			}
			.close-btn:hover {
				background: #f8f9fa;
				color: #495057;
			}
			.left-panel {
				flex: 1;
				border-right: 1px solid #e9ecef;
				display: flex;
				flex-direction: column;
				background: #ffffff;
			}
			.right-panel {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: #ffffff;
			}
			.form-group {
				margin-bottom: 20px;
			}
			label {
				display: block;
				margin-bottom: 8px;
				font-weight: 500;
				color: #495057;
				font-size: 14px;
			}
			input[type='text'],
			select {
				width: 100%;
				padding: 12px 16px;
				border: 2px solid #e9ecef;
				border-radius: 8px;
				font-size: 14px;
				transition: all 0.3s ease;
				background: #ffffff;
				box-sizing: border-box;
			}
			input[type='text']:focus,
			select:focus {
				outline: none;
				border-color: #6c757d;
				box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1);
			}
			.upload-section {
				display: none;
			}
			.upload-area {
				border: 2px dashed #ced4da;
				border-radius: 8px;
				padding: 20px 16px;
				text-align: center;
				margin-bottom: 12px;
				cursor: pointer;
				transition: all 0.3s ease;
				background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
			}
			.upload-area:hover {
				border-color: #6c757d;
				background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(0,0,0,0.1);
			}
			.upload-area.highlight {
				border-color: #6c757d;
				background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
				box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1);
			}
			.upload-area p {
				color: #6c757d;
				margin: 0;
				font-size: 14px;
				font-weight: 500;
			}
			.image-display {
				flex: 1;
				position: relative;
				overflow: hidden;
				background: #f9f9f9;
				display: flex;
				align-items: center;
				justify-content: center;
				border: 2px dashed #ced4da;
				cursor: pointer;
				transition: all 0.3s ease;
			}
			.image-display:hover {
				border-color: #6c757d;
				background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
			}
			.image-display.highlight {
				border-color: #6c757d;
				background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
				box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.1);
			}
			.image-container {
				position: relative;
				width: 100%;
				height: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.image-container img {
				max-width: 100%;
				max-height: 100%;
				object-fit: contain;
				display: block;
				user-select: none;
				-webkit-user-drag: none;
				-khtml-user-drag: none;
				-moz-user-drag: none;
				-o-user-drag: none;
				user-drag: none;
				pointer-events: none;
			}
			.selection-box {
				position: absolute;
				border: 2px solid #2f8ae0;
				background: rgba(47, 138, 224, 0.1);
				pointer-events: none;
				display: block;
				z-index: 15;
				box-sizing: border-box;
				min-width: 1px;
				min-height: 1px;
			}
			.controls-section {
				padding: 12px 16px;
				border-bottom: 1px solid #e9ecef;
				background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
				box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			}
			.control-row {
				display: flex;
				gap: 6px;
				margin-bottom: 8px;
				align-items: center;
				flex-wrap: wrap;
			}
			.control-row.single-row {
				flex-wrap: nowrap;
				gap: 4px;
				justify-content: space-between;
			}
			.control-buttons {
				display: flex;
				gap: 4px;
			}
			.coordinate-display {
				font-size: 12px;
				color: #666;
				margin-top: 5px;
			}
			.progress-container {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-top: 5px;
			}
			.progress-bar {
				flex: 1;
				height: 6px;
				background-color: #e9ecef;
				border-radius: 3px;
				overflow: hidden;
				display: none;
			}
			.progress-fill {
				height: 100%;
				background-color: #007bff;
				transition: width 0.3s ease;
				width: 0%;
			}
			.progress-text {
				font-size: 11px;
				color: #666;
				white-space: nowrap;
				display: none;
			}
			.preview-container {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
				gap: 15px;
				margin-bottom: 20px;
			}
			.preview-item {
				border: 1px solid #eee;
				border-radius: 4px;
				padding: 10px;
				position: relative;
			}
			.preview-item img {
				max-width: 100%;
				height: auto;
				border-radius: 4px;
			}
			.preview-item-info {
				margin-top: 8px;
				font-size: 12px;
			}
			.preview-item-name {
				font-weight: bold;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.preview-item-size {
				color: #888;
			}
			.preview-item-remove {
				position: absolute;
				top: 5px;
				right: 5px;
				background: none;
				border: none;
				font-size: 16px;
				cursor: pointer;
				color: #999;
			}
			.controls {
				display: flex;
				justify-content: space-between;
				margin-bottom: 20px;
			}
			.control-group {
				display: flex;
				gap: 10px;
			}
			button {
				padding: 0 8px;
				background: white;
				color: #2196f3;
				border: 1px solid #2196f3;
				border-radius: 3px;
				cursor: pointer;
				font-size: 11px;
				font-weight: 400;
				transition: all 0.2s ease;
				height: 24px;
				line-height: 24px;
				min-width: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			button:hover {
				background: #2196f3;
				color: white;
			}
			button:active {
				background: #1976d2;
				color: white;
			}
			button:disabled {
				background: #f5f5f5;
				color: #9e9e9e;
				border-color: #e0e0e0;
				cursor: not-allowed;
			}
			.btn-primary {
				background: #2196f3;
				color: white;
				border-color: #2196f3;
			}
			.btn-primary:hover {
				background: #1976d2;
				border-color: #1976d2;
			}
			.btn-success {
				background: white;
				color: #2196f3;
				border-color: #2196f3;
			}
			.btn-success:hover {
				background: #2196f3;
				color: white;
				border-color: #2196f3;
			}
			.btn-secondary {
				background: white;
				color: #6c757d;
				border-color: #6c757d;
			}
			.btn-secondary:hover {
				background: #6c757d;
				color: white;
				border-color: #6c757d;
			}
			.detection-box {
				position: absolute;
				border: 2px solid #e74c3c;
				background: rgba(231, 76, 60, 0.2);
				pointer-events: none;
				box-sizing: border-box;
			}
			.detection-label {
				position: absolute;
				top: -25px;
				left: 0;
				background: #e74c3c;
				color: white;
				padding: 2px 6px;
				font-size: 12px;
				border-radius: 3px;
				white-space: nowrap;
			}
			.image-viewer.selecting {
				cursor: crosshair;
			}
			.image-viewer.selecting .selection-overlay {
				pointer-events: all;
			}
			.selection-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
				z-index: 10;
			}
			.results-container {
				border-top: 1px solid #eee;
				padding-top: 20px;
			}
			.results-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 15px;
			}
			.results-count {
				font-weight: bold;
			}
			.results-controls {
				display: flex;
				gap: 15px;
			}
			select {
				padding: 5px;
				border-radius: 4px;
				border: 1px solid #ccc;
			}
			.results-list {
				max-height: 600px;
				overflow-y: auto;
			}
			.result-item {
				border-bottom: 1px solid #eee;
				padding: 15px 0;
			}
			.result-item-header {
				display: flex;
				align-items: center;
				margin-bottom: 10px;
			}
			.result-item-header img {
				width: 40px;
				height: 40px;
				object-fit: cover;
				border-radius: 4px;
				margin-right: 10px;
			}
			.result-item-title {
				font-weight: bold;
				flex: 1;
			}
			.result-item-status {
				color: #4885e0;
			}
			.result-item-content {
				white-space: pre-wrap;
				line-height: 1.5;
			}
			.result-item-footer {
				display: flex;
				gap: 10px;
				margin-top: 10px;
			}
			.result-item.error .result-item-status {
				color: #f44336;
			}
			.cost-container {
				margin-top: 20px;
				padding: 10px;
				background-color: #f9f9f9;
				border-radius: 4px;
			}
			.cost-container div {
				margin: 5px 0;
				display: flex;
				justify-content: space-between;
			}
			.scroll-indicator {
				text-align: center;
				padding: 10px;
				background-color: #f0f0f0;
				color: #666;
				display: none;
			}
			.dark-mode {
				background-color: #333;
				color: #fff;
			}
			.dark-mode .container {
				background-color: #222;
				color: #fff;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
			}
			.dark-mode .upload-area {
				border-color: #555;
			}
			.dark-mode .preview-item {
				border-color: #444;
			}
			.dark-mode .results-list {
				border-color: #444;
			}
			.dark-mode .result-item.error .result-item-status {
				color: #ff5555;
			}
			.dark-mode .cost-container {
				background-color: #333;
			}
			.progress-container {
				margin: 20px 0;
				display: none;
			}
			.progress-bar-container {
				height: 20px;
				background-color: #f0f0f0;
				border-radius: 10px;
				overflow: hidden;
			}
			#progress-bar {
				height: 100%;
				background-color: #2f8ae0;
				width: 0%;
			}
			.timer-container {
				text-align: center;
				margin-top: 10px;
				font-weight: bold;
			}
			.result-card {
				border: 1px solid #eee;
				border-radius: 6px;
				padding: 12px;
				margin-bottom: 10px;
				cursor: pointer;
				transition: all 0.3s;
			}
			.result-card:hover {
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}
			.result-card-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 8px;
			}
			.result-card-title {
				font-weight: bold;
			}
			.result-card-content {
				display: none;
				white-space: pre-wrap;
				line-height: 1.4;
				font-size: 13px;
				max-height: 200px;
				overflow-y: auto;
			}
			.result-card-footer {
				display: flex;
				justify-content: flex-end;
				margin-top: 8px;
				gap: 6px;
			}
			.result-card-footer button {
				padding: 4px 8px;
				background-color: #f0f0f0;
				color: #333;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
			}
			.top-right-button {
				background-color: #4caf50;
			}
			.top-right-button:hover {
				background-color: #45a049;
			}
			.pin-table-section {
				flex: 1;
				padding: 0;
				overflow: auto;
				display: flex;
				flex-direction: column;
			}
			.pin-table-content {
				flex: 1;
				padding: 5px;
				overflow: auto;
			}
			.pin-table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 10px;
				font-size: 11px;
				table-layout: fixed;
			}
			.pin-table th,
			.pin-table td {
				border: 1px solid #ddd;
				padding: 4px 6px;
				text-align: left;
			}
			.pin-table th:nth-child(1),
			.pin-table td:nth-child(1) {
				width: 60px;
			}
			.pin-table th:nth-child(4),
			.pin-table td:nth-child(4) {
				width: 60px;
				text-align: center;
			}
			.pin-table button {
				padding: 0 8px;
				font-size: 10px;
				border-radius: 3px;
				background: #f1848e;
				color: white;
				border: none;
				cursor: pointer;
				width: auto;
				min-width: 40px;
				height: 24px;
				line-height: 24px;
			}
			.pin-table button:hover {
				background: #c82333;
			}
			.pin-table th {
				background-color: #f5f5f5;
				font-weight: bold;
				font-size: 10px;
			}
			.pin-table tr:nth-child(even) {
				background-color: #f9f9f9;
			}
			.pin-table tr:hover {
				background-color: #e3f2fd;
			}
			.pin-table input {
				width: 100%;
				border: none;
				padding: 4px;
				background: transparent;
			}
			.pin-table input:focus {
				outline: 1px solid #2f8ae0;
				background: white;
			}
			.table-controls {
				display: flex;
				gap: 6px;
				padding: 12px 16px;
				border-bottom: 1px solid #e9ecef;
				background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
				box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			}
			.table-controls button {
				padding: 0 6px;
				font-size: 10px;
				height: 24px;
				line-height: 24px;
			}
			.empty-state {
				text-align: center;
				color: #999;
				padding: 40px;
				font-style: italic;
			}
			.pin-table-content .empty-state {
				padding: 40px 20px;
				margin: 0;
				font-size: 14px;
			}
			.image-navigation {
				padding: 12px 20px;
				border-top: 1px solid #e9ecef;
				background: #f8f9fa;
			}
			.nav-controls {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
				margin-bottom: 8px;
			}
			.nav-btn {
				padding: 0 8px;
				font-size: 12px;
				min-width: 60px;
				height: 24px;
				line-height: 24px;
			}
			.nav-btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			.image-counter {
				font-weight: 500;
				color: #495057;
				font-size: 12px;
				min-width: 50px;
				text-align: center;
				cursor: pointer;
				padding: 4px 8px;
				border-radius: 4px;
				transition: background-color 0.2s ease;
				position: relative;
			}
			.image-counter:hover {
				background-color: #f8f9fa;
			}
			.image-counter::before {
				content: 'ğŸ“„';
				position: absolute;
				left: -18px;
				top: 50%;
				transform: translateY(-50%);
				font-size: 10px;
				opacity: 0.7;
			}


			.image-info {
				text-align: center;
				font-size: 12px;
				color: #6c757d;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.timing-display {
				font-size: 11px;
				color: #6c757d;
				padding: 4px 8px;
				border: 1px solid #e9ecef;
				border-radius: 3px;
				background: #f8f9fa;
				white-space: nowrap;
				min-width: 80px;
				text-align: center;
				flex-shrink: 0;
				margin-left: auto;
			}
			
			/* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
			.image-preview-modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.9);
				z-index: 2000;
				align-items: center;
				justify-content: center;
				cursor: pointer;
			}
			
			.image-preview-content {
				position: relative;
				max-width: 90vw;
				max-height: 90vh;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			
			.image-preview-content img {
				max-width: 100%;
				max-height: 100%;
				object-fit: contain;
				border-radius: 8px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
				cursor: default;
			}
			
			.image-preview-close {
				position: absolute;
				top: 20px;
				right: 20px;
				background: rgba(255, 255, 255, 0.9);
				border: none;
				border-radius: 50%;
				width: 50px;
				height: 50px;
				font-size: 24px;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.2s ease;
				color: #333;
				line-height: 50px;
				font-weight: bold;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			}
			
			.image-preview-close:hover {
				background: rgba(255, 255, 255, 1);
				transform: scale(1.1);
				box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
			}
			
			.image-preview-info {
				position: absolute;
				bottom: 20px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(0, 0, 0, 0.7);
				color: white;
				padding: 8px 16px;
				border-radius: 20px;
				font-size: 14px;
				white-space: nowrap;
			}

			/* å›¾ç‰‡å·¦ä¸Šè§’æ›¿æ¢PDFæŒ‰é’® */
			.replace-pdf-overlay {
				position: absolute;
				top: 10px;
				left: 10px;
				z-index: 15;
				display: none;
			}

			.replace-pdf-overlay button {
				background: rgba(0, 0, 0, 0.7);
				color: white;
				border: none;
				padding: 0 12px;
				border-radius: 4px;
				font-size: 12px;
				cursor: pointer;
				transition: background-color 0.2s;
				height: 24px;
				line-height: 24px;
				min-width: 24px;
			}

			.replace-pdf-overlay button:hover {
				background: rgba(0, 0, 0, 0.9);
			}
		</style>
	</head>
	<body>
		<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
		<div id="image-preview-modal" class="image-preview-modal">
			<div class="image-preview-content">
				<img id="preview-image" src="" alt="é¢„è§ˆå›¾ç‰‡" />
				<button class="image-preview-close" id="close-preview">Ã—</button>
				<div class="image-preview-info" id="preview-info">å›¾ç‰‡ä¿¡æ¯</div>
			</div>
		</div>
		
		<!-- è®¾ç½®æ¨¡æ€æ¡† -->
		<div id="settings-modal" class="settings-modal">
			<div class="settings-content" style="width: 500px;">
				<div class="settings-header">
					<h3 class="settings-title">è®¾ç½®</h3>
					<button class="close-btn" id="close-settings">Ã—</button>
				</div>
				<div class="form-group">
					<label for="provider-select">æ¨¡å‹å‚å•†</label>
					<select id="provider-select">
						<option value="qwen">é€šä¹‰åƒé—®</option>
						<option value="zhipu">æ™ºè°±AI</option>
						<option value="custom">è‡ªå®šä¹‰</option>
					</select>
				</div>
				<div class="form-group" id="model-group">
					<label for="model-select">é€‰æ‹©æ¨¡å‹</label>
					<select id="model-select">
						<option value="qwen-vl-max-latest">qwen-vl-max-latest</option>
						<option value="qwen2.5-vl-7b-instruct">qwen2.5-vl-7b-instruct</option>
						<option value="qwen2.5-vl-72b-instruct">qwen2.5-vl-72b-instruct</option>
						<option value="qvq-72b-preview">qvq-72b-preview</option>
						<option value="qwen-vl-plus">qwen-vl-plus</option>
					</select>
				</div>
				<div class="form-group" id="api-key-group">
					<label for="api-key">APIå¯†é’¥</label>
					<input type="text" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥" />
				</div>
				<div class="form-group" id="api-url-group" style="display: none;">
					<label for="api-url">APIåœ°å€</label>
					<input type="text" id="api-url" placeholder="è¯·è¾“å…¥APIåœ°å€" />
				</div>
				<div class="form-group" id="custom-model-group" style="display: none;">
					<label for="custom-model">æ¨¡å‹åç§°</label>
					<input type="text" id="custom-model" placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°" />
				</div>
				<div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
					<button type="button" id="cancel-settings" style="background: #e9ecef; color: #495057;">å–æ¶ˆ</button>
					<button type="button" id="save-settings" class="btn-primary">ä¿å­˜</button>
				</div>
			</div>
		</div>

		<div class="container">
			<!-- å·¦ä¾§é¢æ¿ -->
			<div class="left-panel">
				<!-- æ§åˆ¶åŒºåŸŸ -->
				<div class="controls-section">
					<div class="control-row single-row">
						<div class="control-buttons">
							<button id="search-position" class="btn-primary" disabled>æœç´¢ç¬¦å·ä½ç½®</button>
							<button id="extract-params" class="btn-success" disabled>æå–å‚æ•°</button>
							<button id="clear-selection">æ¸…é™¤æ¡†é€‰</button>
							<button id="manual-select">æ‰‹åŠ¨æ¡†é€‰</button>
							<button class="btn-secondary" id="hideButton">éšè—çª—å£</button>
							<button class="settings-btn" id="open-settings">è®¾ç½®</button>
						</div>
						<div class="timing-display" id="timing-display">è€—æ—¶: --</div>
					</div>
					<div class="progress-container">
						<div class="coordinate-display" id="coordinate-display">
							åæ ‡ä¿¡æ¯: æœªé€‰æ‹©åŒºåŸŸ
						</div>
						<div class="progress-bar" id="progress-bar">
							<div class="progress-fill" id="progress-fill"></div>
						</div>
						<div class="progress-text" id="progress-text"></div>
					</div>
				</div>
				
				<!-- å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸï¼ˆç°åœ¨ä¹Ÿæ˜¯æ‹–æ‹½åŒºåŸŸï¼‰ -->
				<div class="image-display" id="image-display">
					<div class="selection-overlay" id="selection-overlay"></div>
					<div class="replace-pdf-overlay" id="replace-pdf-overlay">
						<button id="replace-pdf-btn">æ›¿æ¢PDF</button>
					</div>
					<div class="empty-state">æ‹–æ‹½PDFæˆ–å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
					<input type="file" id="file-input" multiple accept=".pdf,image/*" style="display: none" />
				</div>

			<!-- å›¾ç‰‡å¯¼èˆªåŒºåŸŸ -->
			<div class="image-navigation" id="image-navigation" style="display: none;">
				<div class="nav-controls">
				<button id="prev-image" class="nav-btn">â€¹ ä¸Šä¸€å¼ </button>
					<input type="number" id="page-input" min="1" max="1" value="1" placeholder="é¡µç " title="è¾“å…¥é¡µç æŒ‰å›è½¦é”®å¿«é€Ÿè·³è½¬åˆ°æŒ‡å®šé¡µé¢" style="width: 40px; text-align: center; border: 1px solid #ddd; background: white; font-size: 12px; font-weight: 500; color: #495057; border-radius: 3px; padding: 1px 2px;" />
					<span> / </span>
					<span id="total-pages">1</span>
				</span>
				<button id="next-image" class="nav-btn">ä¸‹ä¸€å¼  â€º</button>
			</div>
				<div class="image-info" id="image-info">å½“å‰å›¾ç‰‡</div>
			</div>


			</div>

			<!-- å³ä¾§é¢æ¿ -->
			<div class="right-panel">
				<div class="pin-table-section">
					<div class="table-controls">
						<button id="add-pin">æ·»åŠ å¼•è„š</button>
						<button id="clear-table">æ¸…ç©ºè¡¨æ ¼</button>
						<button id="create-symbol" class="btn-success">åˆ›å»ºç¬¦å·</button>
						<button id="copy-symbol-info" class="btn-secondary" disabled>å¤åˆ¶ç¬¦å·ä¿¡æ¯</button>
					</div>
					<div class="pin-table-content">
						<div id="pin-table-container">
							<div class="empty-state">æš‚æ— å¼•è„šä¿¡æ¯</div>
						</div>
					</div>
				</div>
			</div>

		</div>

		<script>
			// è®¾ç½®PDF.jsçš„workerè·¯å¾„
			pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

			// å…¨å±€å˜é‡
			let uploadedFiles = [];
			let currentImages = [];
			let currentImageIndex = 0;
			let apiKey = '';
			let selectedModel = 'qwen-vl-max-latest';
			let selectedProvider = 'qwen';
			let apiUrl = '';
			let customModel = '';
			let isSelecting = false;
			let selectionStart = { x: 0, y: 0 };
			let selectionEnd = { x: 0, y: 0 };
			let selectionBox = null;
			let currentSelection = null;
			let pinData = [];

			// æ£€æµ‹æ˜¯å¦ä½¿ç”¨ç‰¹æ®ŠAPIæ ¼å¼çš„è¾…åŠ©å‡½æ•°
			function isSpecialApiFormat(provider, url) {
				return provider === 'custom' && url && url.includes('/ai-chat-api/complete');
			}
			let detectionResults = null;
			let processedImages = [];
			let imageSelections = {}; // å­˜å‚¨æ¯å¼ å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
			let startTime = null; // è®¡æ—¶å¼€å§‹æ—¶é—´
			let timingInterval = null; // è®¡æ—¶å™¨é—´éš”
			const modelRates = {
				'qwen-vl-max-latest': { input: 0.003, output: 0.009 },
				'qwen2.5-vl-7b-instruct': { input: 0.002, output: 0.005 },
				'qwen2.5-vl-72b-instruct': { input: 0.016, output: 0.048 },
				'qvq-72b-preview': { input: 0.012, output: 0.036 },
				'qwen-vl-plus': { input: 0.0015, output: 0.0045 },
			};

			// æ¨¡å‹å‚å•†é…ç½®
			const providerConfigs = {
				qwen: {
					name: 'é€šä¹‰åƒé—®',
					apiUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
					models: [
						{ value: 'qwen-vl-max-latest', name: 'qwen-vl-max-latest' },
						{ value: 'qwen2.5-vl-7b-instruct', name: 'qwen2.5-vl-7b-instruct' },
						{ value: 'qwen2.5-vl-72b-instruct', name: 'qwen2.5-vl-72b-instruct' },
						{ value: 'qvq-72b-preview', name: 'qvq-72b-preview' },
						{ value: 'qwen-vl-plus', name: 'qwen-vl-plus' }
					],
					requiresApiKey: true
				},
				zhipu: {
					name: 'æ™ºè°±AI',
					apiUrl: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
					models: [
						{ value: 'glm-4.5v', name: 'GLM-4.5V' }
					],
					requiresApiKey: true
				},
				custom: {
					name: 'è‡ªå®šä¹‰',
					apiUrl: '',
					models: [],
					requiresApiKey: false
				}
			};

			// DOMå…ƒç´ 
			const dropArea = document.getElementById('image-display');
			const fileInput = document.getElementById('file-input');
			const imageDisplay = document.getElementById('image-display');
			const coordinateDisplay = document.getElementById('coordinate-display');
			const clearSelectionButton = document.getElementById('clear-selection');
			const searchPositionButton = document.getElementById('search-position');
			const extractParamsButton = document.getElementById('extract-params');
			const manualSelectButton = document.getElementById('manual-select');
			const hideButton = document.getElementById('hideButton');
			let selectionOverlay = document.getElementById('selection-overlay');
			const settingsModal = document.getElementById('settings-modal');
			const openSettingsBtn = document.getElementById('open-settings');
			const closeSettingsBtn = document.getElementById('close-settings');
			const cancelSettingsBtn = document.getElementById('cancel-settings');
			const providerSelect = document.getElementById('provider-select');
			const modelSelect = document.getElementById('model-select');
			const apiKeyInput = document.getElementById('api-key');
			const apiUrlInput = document.getElementById('api-url');
			const customModelInput = document.getElementById('custom-model');
			const modelGroup = document.getElementById('model-group');
			const apiKeyGroup = document.getElementById('api-key-group');
			const apiUrlGroup = document.getElementById('api-url-group');
			const customModelGroup = document.getElementById('custom-model-group');
			const saveSettingsBtn = document.getElementById('save-settings');
			const addPinButton = document.getElementById('add-pin');
			const clearTableButton = document.getElementById('clear-table');
			const createSymbolButton = document.getElementById('create-symbol');
			const copySymbolInfoButton = document.getElementById('copy-symbol-info');
			const pinTableContainer = document.getElementById('pin-table-container');
			const imageNavigation = document.getElementById('image-navigation');
			const prevImageBtn = document.getElementById('prev-image');
			const nextImageBtn = document.getElementById('next-image');
			const imageCounter = document.getElementById('image-counter');
			const imageInfo = document.getElementById('image-info');
			const progressBar = document.getElementById('progress-bar');
			const progressFill = document.getElementById('progress-fill');
			const progressText = document.getElementById('progress-text');
			const timingDisplay = document.getElementById('timing-display');

			// åˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', function () {
				// EDAå…¼å®¹æ€§æ£€æŸ¥
				if (typeof eda === 'undefined') {
					window.eda = {
						sys_Storage: {
							getExtensionUserConfig: function(key) {
								return localStorage.getItem('eda_' + key);
							},
							setExtensionUserConfig: function(key, value) {
								localStorage.setItem('eda_' + key, value);
							}
						},
						sch_PrimitivePin: {
							create: function() {
								console.log('EDAç¯å¢ƒä¸å¯ç”¨ï¼Œæ— æ³•åˆ›å»ºå¼•è„š');
								return null;
							}
						}
					};
				}

				// åˆå§‹åŒ–è®¾ç½®
				loadSettings();

				// è®¾ç½®æ¨¡æ€æ¡†äº‹ä»¶å¤„ç†
				openSettingsBtn.addEventListener('click', function() {
					settingsModal.style.display = 'flex';
					loadSettings(); // é‡æ–°åŠ è½½è®¾ç½®åˆ°ç•Œé¢
				});

				closeSettingsBtn.addEventListener('click', function() {
					settingsModal.style.display = 'none';
				});

				cancelSettingsBtn.addEventListener('click', function() {
					settingsModal.style.display = 'none';
				});

				saveSettingsBtn.addEventListener('click', function() {
					saveSettings();
					settingsModal.style.display = 'none';
					if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
						eda.sys_ToastMessage.showMessage('è®¾ç½®å·²ä¿å­˜ï¼', 1);
					}
				});

				// æ¨¡å‹å‚å•†åˆ‡æ¢äº‹ä»¶
				providerSelect.addEventListener('change', updateModelOptions);

				// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
				window.addEventListener('click', function(event) {
					if (event.target === settingsModal) {
						settingsModal.style.display = 'none';
					}
				});

				// åˆå§‹åŒ–æ‹–æ”¾åŒºåŸŸ
				initDropArea();
				initButtons();
				initImageSelection();
				initImageNavigation();
				initManualSelection();
				updatePinTable();
				updateUI();
				updateButtons();
			});

			// è®¾ç½®ç›¸å…³å‡½æ•°
			function updateModelOptions() {
				const provider = providerSelect.value;
				const config = providerConfigs[provider];
				
				// æ¸…ç©ºæ¨¡å‹é€‰é¡¹
				modelSelect.innerHTML = '';
				
				if (provider === 'custom') {
					// è‡ªå®šä¹‰æ¨¡å¼ï¼šæ˜¾ç¤ºAPIå¯†é’¥ã€APIåœ°å€ã€æ¨¡å‹åç§°ä¸‰ä¸ªè¾“å…¥æ¡†
					modelGroup.style.display = 'none';
					apiKeyGroup.style.display = 'block';
					apiUrlGroup.style.display = 'block';
					customModelGroup.style.display = 'block';
					
					// è‡ªå®šä¹‰æ¨¡å¼ä¸‹ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¾“å…¥APIåœ°å€
				} else {
					// é¢„è®¾å‚å•†
					modelGroup.style.display = 'block';
					apiKeyGroup.style.display = config.requiresApiKey ? 'block' : 'none';
					apiUrlGroup.style.display = 'none';
					customModelGroup.style.display = 'none';
					
					// æ·»åŠ æ¨¡å‹é€‰é¡¹
					config.models.forEach(model => {
						const option = document.createElement('option');
						option.value = model.value;
						option.textContent = model.name;
						modelSelect.appendChild(option);
					});
				}
			}

			function loadSettings() {
				// ä»å­˜å‚¨ä¸­åŠ è½½è®¾ç½®
				const savedProvider = (typeof eda !== 'undefined' && eda.sys_Storage) ? 
					eda.sys_Storage.getExtensionUserConfig('selected_provider') : 
					localStorage.getItem('selectedProvider');
				const savedApiKey = (typeof eda !== 'undefined' && eda.sys_Storage) ? 
					eda.sys_Storage.getExtensionUserConfig('api_key') : 
					localStorage.getItem('apiKey');
				const savedModel = (typeof eda !== 'undefined' && eda.sys_Storage) ? 
					eda.sys_Storage.getExtensionUserConfig('selected_model') : 
					localStorage.getItem('selectedModel');
				const savedApiUrl = (typeof eda !== 'undefined' && eda.sys_Storage) ? 
					eda.sys_Storage.getExtensionUserConfig('api_url') : 
					localStorage.getItem('apiUrl');
				const savedCustomModel = (typeof eda !== 'undefined' && eda.sys_Storage) ? 
					eda.sys_Storage.getExtensionUserConfig('custom_model') : 
					localStorage.getItem('customModel');
				
				// è®¾ç½®å…¨å±€å˜é‡
				selectedProvider = savedProvider || 'qwen';
				apiKey = savedApiKey || '';
				selectedModel = savedModel || 'qwen-vl-max-latest';
				apiUrl = savedApiUrl || '';
				customModel = savedCustomModel || '';
				
				// æ›´æ–°ç•Œé¢
				providerSelect.value = selectedProvider;
				apiKeyInput.value = apiKey;
				apiUrlInput.value = apiUrl;
				customModelInput.value = customModel;
				
				// æ›´æ–°æ¨¡å‹é€‰é¡¹
				updateModelOptions();
				
				// è®¾ç½®æ¨¡å‹é€‰æ‹©
				if (selectedProvider !== 'custom' && modelSelect.querySelector(`option[value="${selectedModel}"]`)) {
					modelSelect.value = selectedModel;
				}
			}

			function saveSettings() {
				// è·å–ç•Œé¢å€¼
				selectedProvider = providerSelect.value;
				apiKey = apiKeyInput.value;
				apiUrl = apiUrlInput.value;
				customModel = customModelInput.value;
				
				if (selectedProvider === 'custom') {
					selectedModel = customModel;
				} else {
					selectedModel = modelSelect.value;
				}
				
				// ä¿å­˜åˆ°å­˜å‚¨
				if (typeof eda !== 'undefined' && eda.sys_Storage) {
					eda.sys_Storage.setExtensionUserConfig('selected_provider', selectedProvider);
					eda.sys_Storage.setExtensionUserConfig('api_key', apiKey);
					eda.sys_Storage.setExtensionUserConfig('selected_model', selectedModel);
					eda.sys_Storage.setExtensionUserConfig('api_url', apiUrl);
					eda.sys_Storage.setExtensionUserConfig('custom_model', customModel);
				} else {
					localStorage.setItem('selectedProvider', selectedProvider);
					localStorage.setItem('apiKey', apiKey);
					localStorage.setItem('selectedModel', selectedModel);
					localStorage.setItem('apiUrl', apiUrl);
					localStorage.setItem('customModel', customModel);
				}
			}

			/**
			 * é€šç”¨APIè°ƒç”¨å‡½æ•°
			 */
			async function callAPI(data) {
				const config = providerConfigs[selectedProvider];
				const url = selectedProvider === 'custom' ? apiUrl : config.apiUrl;
				
				if (isSpecialApiFormat(selectedProvider, apiUrl)) {
				// è‡ªå®šä¹‰æ¨¡å¼ä½¿ç”¨ç‰¹æ®ŠAPIæ ¼å¼
			const requestData = {
				type: "chat.user.generic_chat",
				context: {
					chat: {
						input_text: data.messages[data.messages.length - 1].content.find(c => c.type === 'text')?.text || '',
						base64_images: data.messages[data.messages.length - 1].content
							.filter(c => c.type === 'image_url')
							.map(c => c.image_url.url.replace('data:image/jpeg;base64,', ''))
					},
					history: [],
					messages: []
				}
			};
			
			const headers = {
				'Content-Type': 'application/json',
				'Accept': 'application/json'
			};
			
			return await eda.sys_ClientUrl.request(
				url,
				'POST',
				JSON.stringify(requestData),
				headers
			);
				} else if (selectedProvider === 'zhipu') {
					// æ™ºè°±AIä½¿ç”¨OpenAIå…¼å®¹æ ¼å¼
					if (!apiKey || apiKey.trim() === '') {
						throw new Error('æ™ºè°±AIéœ€è¦APIå¯†é’¥ï¼Œè¯·åœ¨æ¨¡å‹è®¾ç½®ä¸­è¾“å…¥æ‚¨çš„API Key');
					}
					
					const headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${apiKey.trim()}`
					};
					
					// è½¬æ¢ä¸ºæ™ºè°±AIæ ¼å¼
					const zhipuData = {
						model: data.model,
						messages: data.messages.map(msg => ({
							role: msg.role,
							content: msg.content
						}))
					};
					
					console.log('æ™ºè°±AI APIè°ƒç”¨å‚æ•°:', {
						url: url,
						headers: headers,
						data: zhipuData
					});
					
					return await eda.sys_ClientUrl.request(
						url,
						'POST',
						JSON.stringify(zhipuData),
						{ headers: headers }
					);
				} else if (selectedProvider === 'qwen') {
					// é€šä¹‰åƒé—®ä½¿ç”¨å…¼å®¹æ¨¡å¼æ ¼å¼
					if (!apiKey || apiKey.trim() === '') {
						throw new Error('é€šä¹‰åƒé—®éœ€è¦APIå¯†é’¥ï¼Œè¯·åœ¨æ¨¡å‹è®¾ç½®ä¸­è¾“å…¥æ‚¨çš„API Key');
					}
					
					const headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${apiKey.trim()}`
					};
					
					// è½¬æ¢ä¸ºå…¼å®¹æ¨¡å¼æ ¼å¼
					const qwenData = {
						model: data.model,
						messages: data.messages.map(msg => ({
							role: msg.role,
							content: msg.content
						}))
					};
					
					console.log('é€šä¹‰åƒé—®APIè°ƒç”¨å‚æ•°:', {
						url: url,
						headers: headers,
						data: qwenData
					});
					
					return await eda.sys_ClientUrl.request(
						url,
						'POST',
						JSON.stringify(qwenData),
						{ headers: headers }
					);
				} else {
					// è‡ªå®šä¹‰APIæ ¼å¼
					const headers = {
						'Content-Type': 'application/json'
					};
					
					if (config.requiresApiKey && apiKey) {
						headers['Authorization'] = `Bearer ${apiKey}`;
					}
					
					return await eda.sys_ClientUrl.request(
						url,
						'POST',
						JSON.stringify(data),
						{ headers: headers }
					);
				}
			}

			/**
			 * åˆå§‹åŒ–æ‹–æ”¾åŒºåŸŸçš„äº‹ä»¶ç›‘å¬
			 */
			function initDropArea() {
				['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
					dropArea.addEventListener(eventName, preventDefaults, false);
				});

				['dragenter', 'dragover'].forEach((eventName) => {
					dropArea.addEventListener(eventName, highlight, false);
				});

				['dragleave', 'drop'].forEach((eventName) => {
					dropArea.addEventListener(eventName, unhighlight, false);
				});

				dropArea.addEventListener('drop', handleDrop, false);
				dropArea.addEventListener('click', (e) => {
				// åªæœ‰åœ¨æ²¡æœ‰å›¾ç‰‡æ—¶æ‰è§¦å‘æ–‡ä»¶é€‰æ‹©
				if (currentImages.length === 0) {
					fileInput.click();
				}
			});

				fileInput.addEventListener('change', handleFiles, false);
			}

			/**
			 * é˜»æ­¢é»˜è®¤æ‹–æ”¾è¡Œä¸º
			 */
			function preventDefaults(e) {
				e.preventDefault();
				e.stopPropagation();
			}

			/**
			 * é«˜äº®æ˜¾ç¤ºæ‹–æ”¾åŒºåŸŸ
			 */
			function highlight() {
				dropArea.classList.add('highlight');
			}

			/**
			 * å–æ¶ˆé«˜äº®æ˜¾ç¤º
			 */
			function unhighlight() {
				dropArea.classList.remove('highlight');
			}

			/**
			 * å¤„ç†æ‹–æ”¾çš„æ–‡ä»¶
			 */
			function handleDrop(e) {
				const dt = e.dataTransfer;
				const files = dt.files;
				handleFiles({ target: { files } });
			}

			/**
			 * å¤„ç†æ–‡ä»¶ä¸Šä¼ 
			 */
			async function handleFiles(e) {
				let files = [];
				if (e.dataTransfer) {
					files = e.dataTransfer.files;
				} else if (e.target && e.target.files) {
					files = e.target.files;
				}

				if (files.length === 0) return;

				for (let i = 0; i < files.length; i++) {
					const file = files[i];
					
					if (file.type === 'application/pdf') {
						// å¤„ç†PDFæ–‡ä»¶
						await processPDF(file);
					} else if (file.type.match('image.*')) {
						// å¤„ç†å›¾ç‰‡æ–‡ä»¶
						await processImage(file);
					} else {
						eda.sys_ToastMessage.showMessage(`æ–‡ä»¶ "${file.name}" æ ¼å¼ä¸æ”¯æŒï¼Œè¯·ä¸Šä¼ PDFæˆ–å›¾ç‰‡æ–‡ä»¶`, 2);
						continue;
					}
				}

				updateUI();
			}

			/**
			 * æ˜¾ç¤ºè¿›åº¦æ¡
			 */
			function showProgress() {
				progressBar.style.display = 'block';
				progressText.style.display = 'block';
			}

			/**
			 * éšè—è¿›åº¦æ¡
			 */
			function hideProgress() {
				progressBar.style.display = 'none';
				progressText.style.display = 'none';
				progressFill.style.width = '0%';
			}

			/**
			 * æ›´æ–°è¿›åº¦
			 */
			function updateProgress(percentage, text) {
				progressFill.style.width = percentage + '%';
				progressText.textContent = text;
			}

			/**
			 * å¤„ç†PDFæ–‡ä»¶
			 */
			async function processPDF(file) {
				try {
					// é‡æ–°å¯¼å…¥PDFæ—¶æ¸…é™¤ä¹‹å‰çš„æ•°æ®
					currentImages = [];
					imageSelections = {};
					detectionResults = null;
					clearSelection();
					
					// æ˜¾ç¤ºè¿›åº¦æ¡
					showProgress();
					updateProgress(0, 'å¼€å§‹è§£æPDF...');
					
					const arrayBuffer = await file.arrayBuffer();
					const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
					
					for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
						const progress = Math.round((pageNum / pdf.numPages) * 100);
						updateProgress(progress, `æ­£åœ¨è½¬æ¢ç¬¬ ${pageNum}/${pdf.numPages} é¡µ...`);
						
						const page = await pdf.getPage(pageNum);
						const viewport = page.getViewport({ scale: 1.0 });
						
						const canvas = document.createElement('canvas');
						const context = canvas.getContext('2d');
						canvas.height = viewport.height;
						canvas.width = viewport.width;
						
						await page.render({ canvasContext: context, viewport: viewport }).promise;
						
						const imageData = canvas.toDataURL('image/png');
				currentImages.push({
					src: imageData,
					name: `${file.name} - ç¬¬${pageNum}é¡µ`,
					type: 'pdf-page',
					file: file
				});
					}
					
					updateProgress(100, `PDFè§£æå®Œæˆï¼Œå…±${pdf.numPages}é¡µ`);
					
					if (currentImages.length > 0) {
						currentImageIndex = 0;
						displayCurrentImage();
					}
					
					// å»¶è¿Ÿéšè—è¿›åº¦æ¡
					setTimeout(() => {
						hideProgress();
					}, 1500);
					
					eda.sys_ToastMessage.showMessage(`PDFè§£æå®Œæˆï¼Œå…±${pdf.numPages}é¡µ`, 1);
				} catch (error) {
					console.error('PDFå¤„ç†å¤±è´¥:', error);
					hideProgress();
					eda.sys_ToastMessage.showMessage('PDFå¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 0);
				}
			}

			/**
			 * å¤„ç†å›¾ç‰‡æ–‡ä»¶
			 */
			async function processImage(file) {
				return new Promise((resolve) => {
					const reader = new FileReader();
					reader.onload = function (e) {
					currentImages.push({
						src: e.target.result,
						name: file.name,
						type: 'image',
						file: file
					});
						
						if (currentImages.length === 1) {
							currentImageIndex = 0;
							displayCurrentImage();
						}
						
						resolve();
					};
					reader.readAsDataURL(file);
				});
			}

			/**
			 * ä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
			 */
			function saveCurrentImageSelection() {
				if (currentImages.length === 0 || !selectionOverlay) return;
				
				const imageKey = `image_${currentImageIndex}`;
				const selections = [];
				
				// ä¿å­˜æ‰‹åŠ¨é€‰æ‹©æ¡†
				const selectionBoxes = selectionOverlay.querySelectorAll('.selection-box');
				selectionBoxes.forEach(box => {
					selections.push({
						type: 'manual',
						left: box.style.left,
						top: box.style.top,
						width: box.style.width,
						height: box.style.height,
						border: box.style.border,
						backgroundColor: box.style.backgroundColor
					});
				});
				
				// ä¿å­˜æ£€æµ‹æ¡†
				const detectionBoxes = selectionOverlay.querySelectorAll('.detection-box');
				detectionBoxes.forEach(box => {
					const label = box.querySelector('.detection-label');
					selections.push({
						type: 'detection',
						left: box.style.left,
						top: box.style.top,
						width: box.style.width,
						height: box.style.height,
						labelText: label ? label.textContent : ''
					});
				});
				
				imageSelections[imageKey] = selections;
				console.log(`ä¿å­˜å›¾ç‰‡ ${currentImageIndex + 1} çš„æ¡†é€‰çŠ¶æ€:`, selections);
			}
			
			/**
			 * æ¢å¤å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
			 */
			function restoreCurrentImageSelection() {
				if (currentImages.length === 0 || !selectionOverlay) return;
				
				const imageKey = `image_${currentImageIndex}`;
				const selections = imageSelections[imageKey];
				
				if (!selections || selections.length === 0) {
					console.log(`å›¾ç‰‡ ${currentImageIndex + 1} æ²¡æœ‰ä¿å­˜çš„æ¡†é€‰çŠ¶æ€`);
					return;
				}
				
				console.log(`æ¢å¤å›¾ç‰‡ ${currentImageIndex + 1} çš„æ¡†é€‰çŠ¶æ€:`, selections);
				
				selections.forEach(selection => {
					if (selection.type === 'manual') {
						// æ¢å¤æ‰‹åŠ¨é€‰æ‹©æ¡†
						const selectionBox = document.createElement('div');
						selectionBox.className = 'selection-box';
						selectionBox.style.position = 'absolute';
						selectionBox.style.left = selection.left;
						selectionBox.style.top = selection.top;
						selectionBox.style.width = selection.width;
						selectionBox.style.height = selection.height;
						selectionBox.style.border = selection.border;
						selectionBox.style.backgroundColor = selection.backgroundColor;
						selectionBox.style.zIndex = '12';
						selectionOverlay.appendChild(selectionBox);
					} else if (selection.type === 'detection') {
						// æ¢å¤æ£€æµ‹æ¡†
						const detectionBox = document.createElement('div');
						detectionBox.className = 'detection-box';
						detectionBox.style.position = 'absolute';
						detectionBox.style.left = selection.left;
						detectionBox.style.top = selection.top;
						detectionBox.style.width = selection.width;
						detectionBox.style.height = selection.height;
						detectionBox.style.border = '2px solid #e74c3c';
						detectionBox.style.backgroundColor = 'rgba(231, 76, 60, 0.2)';
						detectionBox.style.zIndex = '11';
						
						if (selection.labelText) {
							const label = document.createElement('div');
							label.className = 'detection-label';
							label.textContent = selection.labelText;
							detectionBox.appendChild(label);
						}
						
						selectionOverlay.appendChild(detectionBox);
					}
				});
				
				// æ›´æ–°åæ ‡æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰æ‰‹åŠ¨é€‰æ‹©æ¡†ï¼‰
				const manualSelections = selections.filter(s => s.type === 'manual');
				if (manualSelections.length > 0) {
					const lastSelection = manualSelections[manualSelections.length - 1];
					const left = parseInt(lastSelection.left);
					const top = parseInt(lastSelection.top);
					const width = parseInt(lastSelection.width);
					const height = parseInt(lastSelection.height);
					updateCoordinateDisplay(left, top, width, height);
				}
				
				// æ¢å¤æ¡†é€‰çŠ¶æ€åæ›´æ–°æŒ‰é’®çŠ¶æ€
				updateButtons();
			}
			
			/**
			 * æ˜¾ç¤ºå½“å‰å›¾ç‰‡
			 */
			function displayCurrentImage() {
				// æ³¨æ„ï¼šæ¡†é€‰çŠ¶æ€çš„ä¿å­˜ç°åœ¨åœ¨å›¾ç‰‡åˆ‡æ¢æ—¶è¿›è¡Œï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œ
				
				if (currentImages.length === 0) {
					imageDisplay.innerHTML = '<div class="empty-state">è¯·ä¸Šä¼ PDFæˆ–å›¾ç‰‡æ–‡ä»¶</div>';
					imageNavigation.style.display = 'none';
					// æ¢å¤è™šçº¿è¾¹æ¡†
					imageDisplay.style.border = '2px dashed #ced4da';
					imageDisplay.style.cursor = 'pointer';
					return;
				}
				
				// ç§»é™¤è™šçº¿è¾¹æ¡†ï¼Œå› ä¸ºæœ‰å›¾ç‰‡äº†
				imageDisplay.style.border = 'none';
				imageDisplay.style.cursor = 'default';
				
				const currentImage = currentImages[currentImageIndex];
				
				// åˆ›å»ºå›¾ç‰‡å®¹å™¨
				const imageContainer = document.createElement('div');
				imageContainer.className = 'image-container';
				
				// åˆ›å»ºå›¾ç‰‡å…ƒç´ 
				const img = document.createElement('img');
				img.src = currentImage.src;
				img.alt = currentImage.name;
				img.id = 'current-image';
				
				// åˆ›å»ºé€‰æ‹©æ¡†å…ƒç´ 
				const selectionBox = document.createElement('div');
				selectionBox.className = 'selection-box';
				selectionBox.id = 'selection-box';
				
				// å°†å›¾ç‰‡å’Œé€‰æ‹©æ¡†æ·»åŠ åˆ°å®¹å™¨ä¸­
				imageContainer.appendChild(img);
				imageContainer.appendChild(selectionBox);
				
				// æ¸…ç©ºå¹¶æ·»åŠ æ–°çš„å›¾ç‰‡å®¹å™¨
				imageDisplay.innerHTML = '';
				imageDisplay.appendChild(imageContainer);
				
				// é‡æ–°æ·»åŠ æ›¿æ¢PDFæŒ‰é’®
				const replacePdfOverlay = document.createElement('div');
				replacePdfOverlay.className = 'replace-pdf-overlay';
				replacePdfOverlay.id = 'replace-pdf-overlay';
				const replacePdfBtn = document.createElement('button');
				replacePdfBtn.id = 'replace-pdf-btn';
				replacePdfBtn.textContent = 'æ›¿æ¢PDF';
				replacePdfBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					fileInput.click();
				});
				replacePdfOverlay.appendChild(replacePdfBtn);
				imageDisplay.appendChild(replacePdfOverlay);
				
				// æ˜¾ç¤ºæ›¿æ¢PDFæŒ‰é’®
				replacePdfOverlay.style.display = 'block';
				
				// é‡æ–°æ·»åŠ é€‰æ‹©è¦†ç›–å±‚
			const newSelectionOverlay = document.createElement('div');
			newSelectionOverlay.className = 'selection-overlay';
			newSelectionOverlay.id = 'selection-overlay';
			imageContainer.appendChild(newSelectionOverlay);
			
			// æ›´æ–°å…¨å±€å˜é‡æŒ‡å‘æ–°çš„overlayå…ƒç´ 
			selectionOverlay = newSelectionOverlay;
				
				// æ˜¾ç¤ºå¯¼èˆªåŒºåŸŸ
				imageNavigation.style.display = 'block';
				
				// æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
				prevImageBtn.disabled = currentImageIndex === 0;
				nextImageBtn.disabled = currentImageIndex === currentImages.length - 1;
				
				// æ›´æ–°é¡µç æ˜¾ç¤º
				const pageInput = document.getElementById('page-input');
				const totalPagesSpan = document.getElementById('total-pages');
				if (pageInput && totalPagesSpan) {
					pageInput.value = currentImageIndex + 1;
					pageInput.max = currentImages.length;
					totalPagesSpan.textContent = currentImages.length;

				}
				

				
				// æ›´æ–°å›¾ç‰‡ä¿¡æ¯
				if (currentImage.name) {
					imageInfo.textContent = `æ–‡ä»¶: ${currentImage.name}`;
				} else {
					imageInfo.textContent = `é¡µé¢ ${currentImageIndex + 1}`;
				}
				
				// é‡æ–°åˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½
				initImageSelection();
				
				// åˆå§‹åŒ–æ‰‹åŠ¨é€‰æ‹©åŠŸèƒ½
				initManualSelection();
				
				// æ¢å¤æ¡†é€‰çŠ¶æ€æˆ–é‡æ–°ç»˜åˆ¶æ£€æµ‹æ¡†
				if (img.complete && img.naturalWidth > 0) {
					// å…ˆå°è¯•æ¢å¤ä¿å­˜çš„æ¡†é€‰çŠ¶æ€
					restoreCurrentImageSelection();
					// å¦‚æœæœ‰æ£€æµ‹ç»“æœï¼Œæ€»æ˜¯é‡æ–°ç»˜åˆ¶æ£€æµ‹æ¡†ï¼ˆç¡®ä¿æ™ºè°±AIç­‰æ¨¡å‹çš„æ£€æµ‹æ¡†èƒ½æ­£ç¡®æ˜¾ç¤ºï¼‰
					if (detectionResults && detectionResults.pdf_position_list) {
						drawDetectionBoxes();
					}
				} else {
					img.onload = () => {
						// å…ˆå°è¯•æ¢å¤ä¿å­˜çš„æ¡†é€‰çŠ¶æ€
						restoreCurrentImageSelection();
						// å¦‚æœæœ‰æ£€æµ‹ç»“æœï¼Œæ€»æ˜¯é‡æ–°ç»˜åˆ¶æ£€æµ‹æ¡†ï¼ˆç¡®ä¿æ™ºè°±AIç­‰æ¨¡å‹çš„æ£€æµ‹æ¡†èƒ½æ­£ç¡®æ˜¾ç¤ºï¼‰
						if (detectionResults && detectionResults.pdf_position_list) {
							drawDetectionBoxes();
						}
					};
				}
				
				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				updateButtons();
			}

			/**
			 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
			 */
			function formatFileSize(bytes) {
				if (bytes < 1024) {
					return bytes + ' B';
				} else if (bytes < 1024 * 1024) {
					return (bytes / 1024).toFixed(2) + ' KB';
				} else {
					return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
				}
			}

			/**
			 * åˆå§‹åŒ–å›¾ç‰‡é€‰æ‹©åŠŸèƒ½
			 */
			function initImageSelection() {
				const imageContainer = document.querySelector('.image-container');
				const currentImage = document.getElementById('current-image');
				selectionBox = document.getElementById('selection-box');
				
				if (!imageContainer || !currentImage || !selectionBox) return;
				
				imageContainer.addEventListener('mousedown', startSelection);
				imageContainer.addEventListener('mousemove', updateSelection);
				imageContainer.addEventListener('mouseup', endSelection);
			}
			
			/**
			 * åˆå§‹åŒ–å›¾ç‰‡å¯¼èˆªåŠŸèƒ½
			 */
			function initImageNavigation() {
				if (prevImageBtn) {
					prevImageBtn.addEventListener('click', () => {
						if (currentImageIndex > 0) {
							// å…ˆä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
							if (selectionOverlay) {
								saveCurrentImageSelection();
							}
							currentImageIndex--;
							displayCurrentImage();
						}
					});
				}
				
				if (nextImageBtn) {
					nextImageBtn.addEventListener('click', () => {
						if (currentImageIndex < currentImages.length - 1) {
							// å…ˆä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
							if (selectionOverlay) {
								saveCurrentImageSelection();
							}
							currentImageIndex++;
							displayCurrentImage();
						}
					});
				}
			
				
				// é¡µç è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
				const pageInput = document.getElementById('page-input');
				const totalPagesSpan = document.getElementById('total-pages');
				const imageCounter = document.getElementById('image-counter');
				
				if (pageInput && totalPagesSpan) {
					// è¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
					pageInput.addEventListener('change', () => {
						if (currentImages.length <= 1) return;
						
						const targetPage = parseInt(pageInput.value);
						if (targetPage >= 1 && targetPage <= currentImages.length) {
							// å…ˆä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
							if (selectionOverlay) {
								saveCurrentImageSelection();
							}
							// æ·»åŠ è·³è½¬æˆåŠŸçš„è§†è§‰åé¦ˆ
							if (imageCounter) {
								imageCounter.style.backgroundColor = '#c8e6c9';
								setTimeout(() => {
									imageCounter.style.backgroundColor = '';
								}, 500);
							}
							currentImageIndex = targetPage - 1;
							displayCurrentImage();
						} else {
							// æ¢å¤åˆ°å½“å‰é¡µç 
							pageInput.value = currentImageIndex + 1;
							// æ·»åŠ é”™è¯¯çš„è§†è§‰åé¦ˆ
							if (imageCounter) {
								imageCounter.style.backgroundColor = '#ffcdd2';
								setTimeout(() => {
									imageCounter.style.backgroundColor = '';
								}, 1000);
							}
							if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
								eda.sys_ToastMessage.showMessage(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${currentImages.length})`, 0);
							} else {
								alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${currentImages.length})`);
							}
						}
					});
					
					// å›è½¦é”®ç¡®è®¤
					pageInput.addEventListener('keypress', (e) => {
						if (e.key === 'Enter') {
							pageInput.blur(); // è§¦å‘changeäº‹ä»¶
						}
					});
					
					// é€‰ä¸­æ–‡æœ¬ä¾¿äºç¼–è¾‘
					pageInput.addEventListener('focus', () => {
						pageInput.select();
					});
				}
				
				// æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
				document.addEventListener('keydown', (e) => {
					if (currentImages.length <= 1) return;
					
					if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
						e.preventDefault();
						// å…ˆä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
						if (selectionOverlay) {
							saveCurrentImageSelection();
						}
						currentImageIndex--;
						displayCurrentImage();
					} else if (e.key === 'ArrowRight' && currentImageIndex < currentImages.length - 1) {
						e.preventDefault();
						// å…ˆä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
						if (selectionOverlay) {
							saveCurrentImageSelection();
						}
						currentImageIndex++;
						displayCurrentImage();
					}
				});
			}

			/**
			 * å¼€å§‹é€‰æ‹©
			 */
			function startSelection(e) {
				if (e.target.tagName !== 'IMG') return;
				
				isSelecting = true;
				const rect = e.target.getBoundingClientRect();
				selectionStart.x = e.clientX - rect.left;
				selectionStart.y = e.clientY - rect.top;
				
				selectionBox.style.display = 'block';
				selectionBox.style.left = selectionStart.x + 'px';
				selectionBox.style.top = selectionStart.y + 'px';
				selectionBox.style.width = '0px';
				selectionBox.style.height = '0px';
				
				e.preventDefault();
			}

			/**
			 * æ›´æ–°é€‰æ‹©
			 */
			function updateSelection(e) {
				if (!isSelecting) return;
				
				const rect = e.target.getBoundingClientRect();
				selectionEnd.x = e.clientX - rect.left;
				selectionEnd.y = e.clientY - rect.top;
				
				const left = Math.min(selectionStart.x, selectionEnd.x);
				const top = Math.min(selectionStart.y, selectionEnd.y);
				const width = Math.abs(selectionEnd.x - selectionStart.x);
				const height = Math.abs(selectionEnd.y - selectionStart.y);
				
				selectionBox.style.left = left + 'px';
				selectionBox.style.top = top + 'px';
				selectionBox.style.width = width + 'px';
				selectionBox.style.height = height + 'px';
				
				updateCoordinateDisplay(left, top, width, height);
			}

			/**
			 * ç»“æŸé€‰æ‹©
			 */
			function endSelection(e) {
				isSelecting = false;
			}

			/**
			 * æ›´æ–°åæ ‡æ˜¾ç¤º
			 */
			function updateCoordinateDisplay(x, y, width, height) {
				coordinateDisplay.textContent = `åæ ‡ä¿¡æ¯: X=${Math.round(x)}, Y=${Math.round(y)}, å®½=${Math.round(width)}, é«˜=${Math.round(height)}`;
			}

			/**
			 * åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
			 */
			function initButtons() {
				// éšè—çª—å£
				hideButton.addEventListener('click', () => {
					eda.sys_IFrame.hideIFrame('symbol');
					eda.sys_ToastMessage.showMessage('é¡µé¢å·²éšè—ï¼Œå¯ç‚¹å‡»ç»§ç»­åˆ›å»ºé‡æ–°æ‰“å¼€', 1);

				});
				
				// æ¸…é™¤æ¡†é€‰
				clearSelectionButton.addEventListener('click', clearSelection);
				
				// æœç´¢ä½ç½®
				searchPositionButton.addEventListener('click', searchPosition);
				
				// æå–å‚æ•°
				extractParamsButton.addEventListener('click', extractParams);
				
				// æ‰‹åŠ¨æ¡†é€‰
				manualSelectButton.addEventListener('click', toggleManualSelection);
				
				// æ·»åŠ å¼•è„š
				addPinButton.addEventListener('click', addPin);
				
				// æ¸…ç©ºè¡¨æ ¼
				clearTableButton.addEventListener('click', clearTable);
				
				// åˆ›å»ºç¬¦å·
				createSymbolButton.addEventListener('click', createSymbolFromTable);
				
				// å¤åˆ¶ç¬¦å·ä¿¡æ¯
				copySymbolInfoButton.addEventListener('click', copySymbolInfo);
				
				// åˆå§‹åŒ–å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
				initImagePreview();
			}

			/**
			 * å¼€å§‹è®¡æ—¶
			 */
			function startTiming() {
				startTime = Date.now();
				timingDisplay.textContent = 'è€—æ—¶: 0.0s';
				
				// æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
				if (timingInterval) {
					clearInterval(timingInterval);
				}
				
				// å¼€å§‹å®æ—¶æ›´æ–°è®¡æ—¶æ˜¾ç¤º
				timingInterval = setInterval(() => {
					if (startTime) {
						const elapsed = (Date.now() - startTime) / 1000;
						timingDisplay.textContent = `è€—æ—¶: ${elapsed.toFixed(1)}s`;
					}
				}, 100);
			}
			
			/**
			 * åœæ­¢è®¡æ—¶
			 */
			function stopTiming() {
				if (timingInterval) {
					clearInterval(timingInterval);
					timingInterval = null;
				}
				
				if (startTime) {
					const elapsed = (Date.now() - startTime) / 1000;
					timingDisplay.textContent = `è€—æ—¶: ${elapsed.toFixed(1)}s`;
					startTime = null;
				}
			}
			
			/**
			 * é‡ç½®è®¡æ—¶æ˜¾ç¤º
			 */
			function resetTiming() {
				if (timingInterval) {
					clearInterval(timingInterval);
					timingInterval = null;
				}
				startTime = null;
				timingDisplay.textContent = 'è€—æ—¶: --';
			}
			
			/**
			 * æ¸…é™¤æ¡†é€‰
			 */
			function clearSelection() {
				// åœæ­¢æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼
				if (manualSelectionMode) {
					stopManualSelection();
					manualSelectButton.textContent = 'æ‰‹åŠ¨æ¡†é€‰';
				}
				
				// æ¸…é™¤æ—§ç‰ˆé€‰æ‹©æ¡†
				if (selectionBox) {
					selectionBox.style.display = 'none';
				}
				
				// æ¸…é™¤æ£€æµ‹æ¡†å’Œæ‰‹åŠ¨é€‰æ‹©ç›¸å…³å…ƒç´ 
				if (selectionOverlay) {
					const existingBoxes = selectionOverlay.querySelectorAll('.detection-box');
					existingBoxes.forEach(box => box.remove());
					
					// æ¸…é™¤æ‰‹åŠ¨é€‰æ‹©æ¡†
					const selectionBoxes = selectionOverlay.querySelectorAll('.selection-box');
					selectionBoxes.forEach(box => box.remove());
					
					// æ¸…é™¤èµ·ç‚¹æ ‡è®°
					const startMarkers = selectionOverlay.querySelectorAll('.start-marker');
					startMarkers.forEach(marker => marker.remove());
				}
				
				// é‡ç½®é€‰æ‹©çŠ¶æ€
				isSelecting = false;
				manualSelectionMode = false;
				firstPoint = null;
				tempSelectionBox = null;
				selectionStart = { x: 0, y: 0 };
				selectionEnd = { x: 0, y: 0 };
				currentSelection = null;
				
				// æ¸…é™¤å½“å‰å›¾ç‰‡çš„ä¿å­˜çŠ¶æ€
				if (currentImages.length > 0) {
					const imageKey = `image_${currentImageIndex}`;
					delete imageSelections[imageKey];
					console.log(`æ¸…é™¤å›¾ç‰‡ ${currentImageIndex + 1} çš„ä¿å­˜çŠ¶æ€`);
				}
				
				// æ¸…é™¤æ£€æµ‹ç»“æœï¼ˆè¿™æ ·æœç´¢ä½ç½®çš„æ¡†é€‰ä¹Ÿä¼šè¢«æ¸…é™¤ï¼‰
				detectionResults = null;
				console.log('æ¸…é™¤æ£€æµ‹ç»“æœ');
				
				coordinateDisplay.textContent = 'åæ ‡ä¿¡æ¯: æœªé€‰æ‹©åŒºåŸŸ';
				
				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				updateButtons();
			}
			
			/**
			 * æœç´¢ä½ç½® - ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«ç¬¦å·ä½ç½®
			 */
			async function searchPosition() {
				if (currentImages.length === 0) {
					eda.sys_ToastMessage.showMessage('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 0);
					return;
				}
				
				// æ£€æŸ¥æ™ºè°±AIæ¨¡å‹é™åˆ¶
				if (selectedProvider === 'zhipu') {
					eda.sys_ToastMessage.showMessage('æ™ºè°±AIæ¨¡å‹ä¸æ”¯æŒæœç´¢ä½ç½®åŠŸèƒ½ï¼Œè¯¥æ¨¡å‹ä¼ è¾“å›¾ç‰‡æœ‰ä¸Šé™', 0);
					return;
				}
				
				// æ£€æŸ¥è®¾ç½®æ˜¯å¦å®Œæ•´
				if (!isSpecialApiFormat(selectedProvider, apiUrl) && (!apiKey || apiKey.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥', 0);
					return;
				}
				
				if (selectedProvider === 'custom' && (!apiUrl || apiUrl.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰APIåœ°å€', 0);
					return;
				}
				
				if (selectedProvider === 'custom' && (!customModel || customModel.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰æ¨¡å‹åç§°', 0);
					return;
				}
				
				try {
				eda.sys_ToastMessage.showMessage('æ­£åœ¨æœç´¢ç¬¦å·ä½ç½®...', 3);
				
				// å¼€å§‹è®¡æ—¶
				startTiming();
					
					// æ„å»ºåŒ…å«æ‰€æœ‰å›¾åƒçš„è¯·æ±‚
					const imageContents = currentImages.map(img => ({
						type: "image_url",
						image_url: { url: img.src }
					}));
					
					const data = {
					model: selectedModel,
					temperature: 0,
					vl_high_resolution_images: true,
					messages: [
							{
								role: 'system',
								content: [{ type: 'text', text: 'You are a professional IC package detection expert.' }]
							},
							{
								role: 'user',
								content: [
									...imageContents,
									{
										type: 'text',
										text: `è¯·åˆ†æè¿™äº›å›¾ç‰‡ï¼Œè¯†åˆ«å‡ºICå°è£…ç¬¦å·çš„ä½ç½®ã€‚ä»¥JSONæ ¼å¼è¾“å‡ºæ‰€æœ‰çš„èŠ¯ç‰‡ç¬¦å·bboxçš„åæ ‡ï¼Œä¸è¦è¾“å‡ºjsonä»£ç æ®µã€‚å¯¹äºæ¯ä¸ªæ£€æµ‹åˆ°çš„ç¬¦å·ï¼Œè¯·è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼š\n\n{
  "input_width": æ¨¡å‹å¤„ç†æ—¶çš„å›¾åƒå®½åº¦,
  "input_height": æ¨¡å‹å¤„ç†æ—¶çš„å›¾åƒé«˜åº¦,
  "pdf_position_list": [
    {
      "page_num": é¡µç (ä»1å¼€å§‹),
      "package_type": "ç¬¦å·ç±»å‹",
      "confidence": ç½®ä¿¡åº¦(0-1),
      "package_rect": {
        "x": xåæ ‡,
        "y": yåæ ‡,
        "width": å®½åº¦,
        "height": é«˜åº¦
      }
    }
  ]
}\n\næ³¨æ„ï¼šåæ ‡åº”è¯¥åŸºäºæ¨¡å‹å®é™…å¤„ç†çš„å›¾åƒå°ºå¯¸ï¼Œè¯·åœ¨è¿”å›ç»“æœä¸­åŒ…å«input_widthå’Œinput_heightå­—æ®µã€‚
`
									}
								]
							}
						]
					};
					
					const response = await callAPI(data);
					
					if (!response.ok) {
						throw new Error('APIè¯·æ±‚å¤±è´¥');
					}
					
					let result, content;
					
					if (isSpecialApiFormat(selectedProvider, apiUrl)) {
					// è‡ªå®šä¹‰æ¨¡å¼ä½¿ç”¨ç‰¹æ®ŠAPIå“åº”å¤„ç†
					const responseText = await response.text();
					console.log('ç‰¹æ®ŠAPIåŸå§‹å“åº”:', responseText);
					
					// é¦–å…ˆå°è¯•ç›´æ¥è§£æä¸ºJSONï¼ˆç‰¹æ®ŠAPIå¯èƒ½ç›´æ¥è¿”å›JSONæ ¼å¼ï¼‰
					try {
						result = JSON.parse(responseText);
						console.log('ç‰¹æ®ŠAPIå“åº”è§£ææˆåŠŸ:', result);
						
						// å¦‚æœç›´æ¥è§£ææˆåŠŸä¸”åŒ…å«pdf_position_listï¼Œç›´æ¥ä½¿ç”¨
						if (result.pdf_position_list && Array.isArray(result.pdf_position_list)) {
							console.log('ç‰¹æ®ŠAPIç›´æ¥è¿”å›äº†pdf_position_list');
							detectionResults = result;
							content = null; // è·³è¿‡contentè§£æ
						} else {
							// å¦åˆ™æŒ‰ç…§åŸæœ‰é€»è¾‘å¤„ç†
							if (result.context && result.context.chat && result.context.chat.input_text) {
								content = result.context.chat.input_text;
							} else if (result.data && result.data.content) {
								content = result.data.content;
							} else if (result.content) {
								content = result.content;
							} else if (result.response) {
								content = result.response;
							} else {
								// å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å°†æ•´ä¸ªresultä½œä¸ºå†…å®¹
								content = JSON.stringify(result);
								console.log('ä½¿ç”¨æ•´ä¸ªresultä½œä¸ºå†…å®¹:', content);
							}
						}
					} catch (parseError) {
						// å¦‚æœJSONè§£æå¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬
						console.log('ç‰¹æ®ŠAPIå“åº”ä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬:', responseText);
						content = responseText;
					}
					} else {
						// é€šä¹‰åƒé—®ã€æ™ºè°±AIå’Œè‡ªå®šä¹‰APIå“åº”å¤„ç†
						result = await response.json();
						
						// å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
						if (selectedProvider === 'zhipu' && result.choices && result.choices[0]) {
							// æ™ºè°±AIå“åº”æ ¼å¼
							content = result.choices[0].message.content;
						} else if (selectedProvider === 'qwen' && result.choices && result.choices[0]) {
							// é€šä¹‰åƒé—®å…¼å®¹æ¨¡å¼å“åº”æ ¼å¼
							content = result.choices[0].message.content;
						} else if (Array.isArray(result) && result[0] && result[0].message) {
							// å¤„ç†æ•°ç»„æ ¼å¼çš„å“åº”
							content = result[0].message.content;
						} else if (result.choices && result.choices[0]) {
							// å¤„ç†æ ‡å‡†æ ¼å¼çš„å“åº”
							content = result.choices[0].message.content;
						} else if (result.pdf_position_list) {
							// å¤„ç†ç›´æ¥è¿”å›æ£€æµ‹ç»“æœçš„æ ¼å¼
							detectionResults = result;
							content = null; // è·³è¿‡contentè§£æ
						} else {
							throw new Error('æ— æ³•è§£æAPIå“åº”æ ¼å¼');
						}
					}
					
					// è§£ææ£€æµ‹ç»“æœ
					try {
						if (content !== null) {
							// æ›´å¼ºå¥çš„JSONæ¸…ç†é€»è¾‘
							let cleanContent = content;
							
							// æ™ºè°±AIç‰¹æ®Šæ ‡è®°å¤„ç†
							if (selectedProvider === 'zhipu') {
								// æå–<|begin_of_box|>å’Œ<|end_of_box|>ä¹‹é—´çš„å†…å®¹
								const boxMatch = cleanContent.match(/<\|begin_of_box\|>([\s\S]*?)<\|end_of_box\|>/);
								if (boxMatch) {
									cleanContent = boxMatch[1].trim();
									console.log('æ™ºè°±AIæå–çš„JSONå†…å®¹:', cleanContent);
								}
							}
							
							// ç§»é™¤å¯èƒ½çš„ä»£ç å—æ ‡è®°
							cleanContent = cleanContent.replace(/^```json\s*\n?/i, '');
							cleanContent = cleanContent.replace(/\n?```\s*$/i, '');
							cleanContent = cleanContent.replace(/^```\s*\n?/i, '');
							
							// ç§»é™¤å¯èƒ½çš„å‰åç©ºç™½å­—ç¬¦
							cleanContent = cleanContent.trim();
							
							// å¦‚æœå†…å®¹ä»¥{å¼€å¤´ä½†å‰é¢æœ‰å…¶ä»–å­—ç¬¦ï¼Œå°è¯•æå–JSONéƒ¨åˆ†
							const jsonMatch = cleanContent.match(/\{[\s\S]*\}/);
							if (jsonMatch) {
								cleanContent = jsonMatch[0];
							}
							
							const parsedContent = JSON.parse(cleanContent);
							
							// å¤„ç†å¯èƒ½çš„æ•°ç»„æ ¼å¼å“åº”
							if (Array.isArray(parsedContent) && parsedContent.length > 0) {
								detectionResults = parsedContent[0];
							} else {
								detectionResults = parsedContent;
							}
						}
						// å¦‚æœcontentä¸ºnullï¼Œè¯´æ˜å·²ç»ç›´æ¥è·å¾—äº†detectionResults
						
						console.log('è§£æçš„æ£€æµ‹ç»“æœ:', detectionResults);
						
						// åœæ­¢è®¡æ—¶
						stopTiming();
						
						// éªŒè¯æ£€æµ‹ç»“æœæ•°æ®ç»“æ„
						if (!detectionResults || !detectionResults.pdf_position_list || !Array.isArray(detectionResults.pdf_position_list)) {
							throw new Error('æ£€æµ‹ç»“æœæ•°æ®æ ¼å¼ä¸æ­£ç¡®');
						}
						
						// ç»˜åˆ¶æ£€æµ‹æ¡†
						drawDetectionBoxes();
						
						// è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæ£€æµ‹æ¡†æ‰€åœ¨çš„é¡µé¢
						if (detectionResults.pdf_position_list.length > 0) {
							const firstDetection = detectionResults.pdf_position_list[0];
							const firstDetectionPage = firstDetection.page_num;
							const targetImageIndex = firstDetectionPage - 1;
							
							if (targetImageIndex >= 0 && targetImageIndex < currentImages.length && targetImageIndex !== currentImageIndex) {
								// ä¿å­˜å½“å‰å›¾ç‰‡çš„æ¡†é€‰çŠ¶æ€
								saveCurrentImageSelection();
								// è·³è½¬åˆ°ç›®æ ‡é¡µé¢
								currentImageIndex = targetImageIndex;
								displayCurrentImage();
								eda.sys_ToastMessage.showMessage(`å·²è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ ${firstDetectionPage} é¡µ`, 1);
							}
						}
						
						// æ›´æ–°æŒ‰é’®çŠ¶æ€
						updateButtons();
						
						eda.sys_ToastMessage.showMessage(`æ£€æµ‹åˆ° ${detectionResults.pdf_position_list.length} ä¸ªç¬¦å·`, 1);
					} catch (parseError) {
					console.error('è§£ææ£€æµ‹ç»“æœå¤±è´¥:', parseError);
					console.error('åŸå§‹å†…å®¹:', content);
					// åœæ­¢è®¡æ—¶
					stopTiming();
					eda.sys_ToastMessage.showMessage('è§£ææ£€æµ‹ç»“æœå¤±è´¥', 0);
				}
				
			} catch (error) {
				console.error('æœç´¢ä½ç½®å¤±è´¥:', error);
				// åœæ­¢è®¡æ—¶
				stopTiming();
				eda.sys_ToastMessage.showMessage('æœç´¢ä½ç½®å¤±è´¥: ' + error.message, 0);
			}
			}
			
			/**
			 * æå–å‚æ•° - ç¬¬äºŒæ­¥ï¼šæå–å¼•è„šä¿¡æ¯
			 */
			async function extractParams() {
				apiKey = apiKeyInput.value.trim();
				selectedModel = modelSelect.value;
				
				// æ£€æŸ¥è®¾ç½®æ˜¯å¦å®Œæ•´
				if (!isSpecialApiFormat(selectedProvider, apiUrl) && (!apiKey || apiKey.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥', 0);
					return;
				}
				
				if (selectedProvider === 'custom' && (!apiUrl || apiUrl.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰APIåœ°å€', 0);
					return;
				}
				
				if (selectedProvider === 'custom' && (!customModel || customModel.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰æ¨¡å‹åç§°', 0);
					return;
				}
				
				// æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æœ‰æ¡†é€‰ï¼ˆæ‰‹åŠ¨æ¡†é€‰æˆ–æœç´¢ä½ç½®çš„è‡ªåŠ¨æ¡†é€‰ï¼‰
				const imagesWithSelections = [];
				
				for (let i = 0; i < currentImages.length; i++) {
					const imageKey = `image_${i}`;
					const selections = imageSelections[imageKey];
					
					if (selections && selections.length > 0) {
						imagesWithSelections.push({
							index: i,
							image: currentImages[i],
							selections: selections
						});
					}
				}
				
				if (imagesWithSelections.length === 0) {
					eda.sys_ToastMessage.showMessage('è¯·å…ˆè¿›è¡Œæ‰‹åŠ¨æ¡†é€‰æˆ–æœç´¢ä½ç½®', 0);
					return;
				}
				
				try {
				eda.sys_ToastMessage.showMessage(`æ­£åœ¨æå– ${imagesWithSelections.length} å¼ å›¾ç‰‡çš„å¼•è„šä¿¡æ¯...`, 3);
				
				// å¼€å§‹è®¡æ—¶
				startTiming();
					
					// æ„å»ºåŒ…å«æ‰€æœ‰æœ‰æ¡†é€‰å›¾ç‰‡çš„è¯·æ±‚
					const imageContents = [];
					let totalSelections = 0;
					
					for (const imageData of imagesWithSelections) {
						console.log(`æ·»åŠ å›¾ç‰‡ ${imageData.index + 1}ï¼Œæ¡†é€‰æ•°é‡: ${imageData.selections.length}`);
						imageContents.push({
							type: "image_url",
							image_url: { url: imageData.image.src }
						});
						totalSelections += imageData.selections.length;
					}
					
					// æ·»åŠ æ–‡æœ¬æç¤º
					imageContents.push({
						type: 'text',
						text: `ä»èŠ¯ç‰‡å°è£…æ‰‹å†Œçš„ç¬¦å·å›¾ä¸­æå–å¼•è„šä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼•è„šå·(pinNumber)å’Œå¼•è„šåç§°(pinName)ã€‚è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦è¾“å‡ºjsonä»£ç æ®µï¼ŒJSONæ ¼å¼å¦‚ä¸‹ï¼š\n\`\`\`json\n{\n  "pins": [\n    {"pinNumber": "1", "pinName": "VCC"},\n    {"pinNumber": "2", "pinName": "GND"}\n  ]\n}\n\`\`\``
					});
					
					const data = {
						model: selectedModel,
						temperature: 0,
						vl_high_resolution_images: true,
						messages: [
							{
								role: 'system',
								content: [{ type: 'text', text: 'You are a helpful assistant specialized in analyzing chip pinout diagrams.' }]
							},
							{
								role: 'user',
								content: imageContents
							}
						]
					};
					
					const response = await callAPI(data);
					
					if (!response.ok) {
						throw new Error('APIè¯·æ±‚å¤±è´¥');
					}
					
					let result, content;
					
					if (isSpecialApiFormat(selectedProvider, apiUrl)) {
					// è‡ªå®šä¹‰æ¨¡å¼ä½¿ç”¨ç‰¹æ®ŠAPIå“åº”å¤„ç†
					const responseText = await response.text();
					console.log('ç‰¹æ®ŠAPIåŸå§‹å“åº”:', responseText);
					
					// é¦–å…ˆå°è¯•ç›´æ¥è§£æä¸ºJSONï¼ˆç‰¹æ®ŠAPIå¯èƒ½ç›´æ¥è¿”å›JSONæ ¼å¼ï¼‰
					try {
						result = JSON.parse(responseText);
						console.log('ç‰¹æ®ŠAPIå“åº”è§£ææˆåŠŸ:', result);
						
						// å¦‚æœç›´æ¥è§£ææˆåŠŸä¸”åŒ…å«pinsæ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨
						if (result.pins && Array.isArray(result.pins)) {
							console.log('ç‰¹æ®ŠAPIç›´æ¥è¿”å›äº†pinsæ•°ç»„');
							content = JSON.stringify(result);
						} else {
							// å¦åˆ™æŒ‰ç…§åŸæœ‰é€»è¾‘å¤„ç†
							if (result.context && result.context.chat && result.context.chat.input_text) {
								content = result.context.chat.input_text;
							} else if (result.data && result.data.content) {
								content = result.data.content;
							} else if (result.content) {
								content = result.content;
							} else if (result.response) {
								content = result.response;
							} else {
								// å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å°†æ•´ä¸ªresultä½œä¸ºå†…å®¹
								content = JSON.stringify(result);
								console.log('ä½¿ç”¨æ•´ä¸ªresultä½œä¸ºå†…å®¹:', content);
							}
						}
					} catch (parseError) {
						// å¦‚æœJSONè§£æå¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬
						console.log('ç‰¹æ®ŠAPIå“åº”ä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬:', responseText);
						content = responseText;
					}
					} else {
						// é€šä¹‰åƒé—®ã€æ™ºè°±AIå’Œè‡ªå®šä¹‰APIå“åº”å¤„ç†
						result = await response.json();
						
						// å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
						if (selectedProvider === 'zhipu' && result.choices && result.choices[0]) {
							// æ™ºè°±AIå“åº”æ ¼å¼
							content = result.choices[0].message.content;
						} else if (selectedProvider === 'qwen' && result.choices && result.choices[0]) {
							// é€šä¹‰åƒé—®å…¼å®¹æ¨¡å¼å“åº”æ ¼å¼
							content = result.choices[0].message.content;
						} else if (Array.isArray(result) && result[0] && result[0].message) {
							// å¤„ç†æ•°ç»„æ ¼å¼çš„å“åº”
							content = result[0].message.content;
						} else if (result.choices && result.choices[0]) {
							// å¤„ç†æ ‡å‡†æ ¼å¼çš„å“åº”
							content = result.choices[0].message.content;
						} else {
							throw new Error('æ— æ³•è§£æAPIå“åº”æ ¼å¼');
						}
					}
					
					// è§£æå¹¶æ·»åŠ å¼•è„šä¿¡æ¯
				parseAndAddPins(content);
				
				// åœæ­¢è®¡æ—¶
				stopTiming();
				
				eda.sys_ToastMessage.showMessage(`æˆåŠŸæå– ${imagesWithSelections.length} å¼ å›¾ç‰‡çš„å¼•è„šä¿¡æ¯`, 1);
				
			} catch (error) {
				console.error('æå–å‚æ•°å¤±è´¥:', error);
				// åœæ­¢è®¡æ—¶
				stopTiming();
				eda.sys_ToastMessage.showMessage('æå–å‚æ•°å¤±è´¥: ' + error.message, 0);
			}
			}
			
			// æ‰‹åŠ¨é€‰æ‹©çŠ¶æ€å˜é‡
			let manualSelectionMode = false;
			let firstPoint = null;
			let tempSelectionBox = null;
			
			/**
			 * åˆ‡æ¢æ‰‹åŠ¨æ¡†é€‰æ¨¡å¼
			 */
			function toggleManualSelection() {
				if (manualSelectionMode) {
					stopManualSelection();
					manualSelectButton.textContent = 'æ‰‹åŠ¨æ¡†é€‰';
				} else {
					startManualSelection();
					manualSelectButton.textContent = 'åœæ­¢æ¡†é€‰';
				}
			}
			
			/**
			 * å¼€å§‹æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼
			 */
			function startManualSelection() {
				manualSelectionMode = true;
				firstPoint = null;
				if (imageDisplay) {
					imageDisplay.classList.add('selecting');
				}
				// ç¡®ä¿selectionOverlayå¯ä»¥æ¥æ”¶é¼ æ ‡äº‹ä»¶
				if (selectionOverlay) {
					selectionOverlay.style.pointerEvents = 'all';
				}
				eda.sys_ToastMessage.showMessage('è¯·ç‚¹å‡»å›¾ç‰‡é€‰æ‹©èµ·ç‚¹', 2);
			}
			
			/**
			 * åœæ­¢æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼
			 */
			function stopManualSelection() {
				manualSelectionMode = false;
				firstPoint = null;
				if (imageDisplay) {
					imageDisplay.classList.remove('selecting');
				}
				
				// é‡ç½®selectionOverlayçš„pointer-events
				if (selectionOverlay) {
					selectionOverlay.style.pointerEvents = 'none';
				}
				
				// æ¸…é™¤ä¸´æ—¶é€‰æ‹©æ¡†
				if (tempSelectionBox) {
					tempSelectionBox.remove();
					tempSelectionBox = null;
				}
			}
			
			// å­˜å‚¨äº‹ä»¶ç›‘å¬å™¨å¼•ç”¨
			let manualSelectionHandlers = {
				click: null
			};
			
			/**
			 * åˆå§‹åŒ–æ‰‹åŠ¨é€‰æ‹©åŠŸèƒ½
			 */
			function initManualSelection() {
				if (!selectionOverlay) return;
				
				console.log('åˆå§‹åŒ–æ‰‹åŠ¨é€‰æ‹©åŠŸèƒ½');
				
				// ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
				if (manualSelectionHandlers.click) {
					selectionOverlay.removeEventListener('click', manualSelectionHandlers.click);
				}
				
				// ç¡®ä¿overlayè¦†ç›–æ•´ä¸ªå›¾åƒåŒºåŸŸ
				selectionOverlay.style.position = 'absolute';
				selectionOverlay.style.top = '0';
				selectionOverlay.style.left = '0';
				selectionOverlay.style.width = '100%';
				selectionOverlay.style.height = '100%';
				selectionOverlay.style.zIndex = '10';
				
				// åˆ›å»ºç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
				manualSelectionHandlers.click = (e) => {
					if (!manualSelectionMode) return;
					
					const rect = selectionOverlay.getBoundingClientRect();
					const clickPoint = {
						x: e.clientX - rect.left,
						y: e.clientY - rect.top
					};
					
					if (!firstPoint) {
						// ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šè®¾ç½®èµ·ç‚¹
						firstPoint = clickPoint;
						console.log('è®¾ç½®èµ·ç‚¹:', firstPoint);
						
						// åˆ›å»ºèµ·ç‚¹æ ‡è®°
						const startMarker = document.createElement('div');
						startMarker.className = 'start-marker';
						startMarker.style.position = 'absolute';
						startMarker.style.left = (firstPoint.x - 3) + 'px';
						startMarker.style.top = (firstPoint.y - 3) + 'px';
						startMarker.style.width = '6px';
						startMarker.style.height = '6px';
						startMarker.style.backgroundColor = '#ff0000';
						startMarker.style.borderRadius = '50%';
						startMarker.style.zIndex = '15';
						selectionOverlay.appendChild(startMarker);
						
						eda.sys_ToastMessage.showMessage('èµ·ç‚¹å·²è®¾ç½®ï¼Œè¯·ç‚¹å‡»ç»ˆç‚¹', 2);
					} else {
						// ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šè®¾ç½®ç»ˆç‚¹å¹¶åˆ›å»ºé€‰æ‹©æ¡†
						const secondPoint = clickPoint;
						console.log('è®¾ç½®ç»ˆç‚¹:', secondPoint);
						
						// è®¡ç®—é€‰æ‹©æ¡†çš„ä½ç½®å’Œå°ºå¯¸
						const left = Math.min(firstPoint.x, secondPoint.x);
						const top = Math.min(firstPoint.y, secondPoint.y);
						const width = Math.abs(secondPoint.x - firstPoint.x);
						const height = Math.abs(secondPoint.y - firstPoint.y);
						
						// åˆ›å»ºé€‰æ‹©æ¡†
						const selectionBox = document.createElement('div');
						selectionBox.className = 'selection-box';
						selectionBox.style.position = 'absolute';
						selectionBox.style.left = left + 'px';
						selectionBox.style.top = top + 'px';
						selectionBox.style.width = width + 'px';
						selectionBox.style.height = height + 'px';
						selectionBox.style.border = '2px solid #007bff';
						selectionBox.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
						selectionBox.style.zIndex = '12';
						selectionOverlay.appendChild(selectionBox);
						
						// æ›´æ–°åæ ‡æ˜¾ç¤º
						updateCoordinateDisplay(left, top, width, height);
						
						// ä¿å­˜æ‰‹åŠ¨é€‰æ‹©æ¡†åˆ°imageSelections
						const imageKey = `image_${currentImageIndex}`;
						if (!imageSelections[imageKey]) {
							imageSelections[imageKey] = [];
						}
						imageSelections[imageKey].push({
							type: 'manual',
							left: left + 'px',
							top: top + 'px',
							width: width + 'px',
							height: height + 'px',
							border: '2px solid #007bff',
							backgroundColor: 'rgba(0, 123, 255, 0.1)'
						});
						
						console.log('æ‰‹åŠ¨é€‰æ‹©å®Œæˆ:', {
							page: currentImageIndex + 1,
							selection: { left, top, width, height }
						});
						console.log(`ä¿å­˜æ‰‹åŠ¨æ¡†é€‰åˆ°å›¾ç‰‡ ${currentImageIndex + 1}:`, imageSelections[imageKey]);
						
						// æ›´æ–°æŒ‰é’®çŠ¶æ€
						updateButtons();
						
						// åœæ­¢é€‰æ‹©æ¨¡å¼
						stopManualSelection();
						manualSelectButton.textContent = 'æ‰‹åŠ¨æ¡†é€‰';
						
						eda.sys_ToastMessage.showMessage('é€‰æ‹©æ¡†å·²åˆ›å»º', 1);
					}
					
					e.preventDefault();
					e.stopPropagation();
				};
				
				// æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
				selectionOverlay.addEventListener('click', manualSelectionHandlers.click);
			}
			
			/**
			 * ç»˜åˆ¶æ£€æµ‹æ¡†
			 */
			function drawDetectionBoxes() {
				console.log('å¼€å§‹ç»˜åˆ¶æ£€æµ‹æ¡†ï¼ŒdetectionResults:', detectionResults);
				
				if (!detectionResults || !detectionResults.pdf_position_list) {
					console.log('æ²¡æœ‰æ£€æµ‹ç»“æœï¼Œè·³è¿‡ç»˜åˆ¶');
					return;
				}
				
				// æ¸…é™¤ç°æœ‰æ£€æµ‹æ¡†
				const existingBoxes = selectionOverlay.querySelectorAll('.detection-box');
				console.log('æ¸…é™¤ç°æœ‰æ£€æµ‹æ¡†æ•°é‡:', existingBoxes.length);
				existingBoxes.forEach(box => box.remove());
				
				// è·å–å½“å‰å›¾åƒ
				const currentImage = imageDisplay.querySelector('img');
				if (!currentImage) {
					console.log('æ²¡æœ‰æ‰¾åˆ°å½“å‰å›¾åƒ');
					return;
				}
				
				console.log('å½“å‰å›¾åƒç´¢å¼•:', currentImageIndex);
				
				// ç­‰å¾…å›¾åƒåŠ è½½å®Œæˆåç»˜åˆ¶
				function drawBoxes() {
				const imageRect = currentImage.getBoundingClientRect();
				const overlayRect = selectionOverlay.getBoundingClientRect();
				
				console.log('å›¾åƒå°ºå¯¸:', {
					imageRect: imageRect,
					overlayRect: overlayRect,
					naturalWidth: currentImage.naturalWidth,
					naturalHeight: currentImage.naturalHeight
				});
				
				// ä¿®æ­£ï¼šè®¡ç®—å›¾ç‰‡ç›¸å¯¹äºoverlayçš„å®é™…åç§»
				const offsetX = imageRect.left - overlayRect.left;
				const offsetY = imageRect.top - overlayRect.top;
				
				// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
				const scaleX = imageRect.width / currentImage.naturalWidth;
				const scaleY = imageRect.height / currentImage.naturalHeight;
				
				console.log('ç¼©æ”¾å‚æ•°:', { offsetX, offsetY, scaleX, scaleY });
					
					// ç»˜åˆ¶å½“å‰é¡µé¢çš„æ£€æµ‹æ¡†
				const currentPageNum = currentImageIndex + 1;
				console.log('å½“å‰é¡µç :', currentPageNum);
				
				// è·å–æ¨¡å‹è¾“å…¥å°ºå¯¸ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
				const modelInputWidth = detectionResults.input_width || currentImage.naturalWidth;
				const modelInputHeight = detectionResults.input_height || currentImage.naturalHeight;
				
				console.log('åæ ‡æ˜ å°„å‚æ•°:', {
					modelInputWidth,
					modelInputHeight,
					originalWidth: currentImage.naturalWidth,
					originalHeight: currentImage.naturalHeight,
					needMapping: modelInputWidth !== currentImage.naturalWidth || modelInputHeight !== currentImage.naturalHeight,
					scaleFactorX: currentImage.naturalWidth / modelInputWidth,
					scaleFactorY: currentImage.naturalHeight / modelInputHeight
				});
				
				let drawnBoxes = 0;
				detectionResults.pdf_position_list.forEach((detection, index) => {
					console.log(`æ£€æµ‹ç»“æœ ${index}:`, detection);
					
					if (detection.page_num === currentPageNum) {
						const rect = detection.package_rect;
						
						// åæ ‡æ˜ å°„ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦ä»æ¨¡å‹è¾“å…¥å°ºå¯¸æ˜ å°„åˆ°åŸå›¾å°ºå¯¸
						let mappedX, mappedY, mappedWidth, mappedHeight;
						
						// å¦‚æœæ¨¡å‹è¾“å…¥å°ºå¯¸ä¸åŸå›¾å°ºå¯¸ä¸åŒï¼Œè¯´æ˜éœ€è¦æ˜ å°„
						if (modelInputWidth !== currentImage.naturalWidth || modelInputHeight !== currentImage.naturalHeight) {
							// ä»æ¨¡å‹è¾“å…¥å°ºå¯¸æ˜ å°„åˆ°åŸå›¾å°ºå¯¸
							mappedX = (rect.x / modelInputWidth) * currentImage.naturalWidth;
							mappedY = (rect.y / modelInputHeight) * currentImage.naturalHeight;
							mappedWidth = (rect.width / modelInputWidth) * currentImage.naturalWidth;
							mappedHeight = (rect.height / modelInputHeight) * currentImage.naturalHeight;
						} else {
							// åæ ‡å·²ç»æ˜¯åŸºäºåŸå›¾å°ºå¯¸çš„ï¼Œç›´æ¥ä½¿ç”¨
							mappedX = rect.x;
							mappedY = rect.y;
							mappedWidth = rect.width;
							mappedHeight = rect.height;
						}
						
						// ä¿®æ­£ï¼šåº”ç”¨æ­£ç¡®çš„åç§»å’Œç¼©æ”¾
						const left = offsetX + mappedX * scaleX;
						const top = offsetY + mappedY * scaleY;
						const width = mappedWidth * scaleX;
						const height = mappedHeight * scaleY;
						
						// è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿æ£€æµ‹æ¡†ä¸è¶…å‡ºå›¾ç‰‡èŒƒå›´
						const maxLeft = offsetX + imageRect.width;
						const maxTop = offsetY + imageRect.height;
						
						if (left >= offsetX && top >= offsetY && 
							left + width <= maxLeft && top + height <= maxTop) {
							
							const detectionBox = document.createElement('div');
							detectionBox.className = 'detection-box';
							
							detectionBox.style.left = left + 'px';
							detectionBox.style.top = top + 'px';
							detectionBox.style.width = width + 'px';
							detectionBox.style.height = height + 'px';
							
							console.log(`ç»˜åˆ¶æ£€æµ‹æ¡† ${index}:`, {
								original: rect,
								mapped: { mappedX, mappedY, mappedWidth, mappedHeight },
								scaled: { left, top, width, height },
								mappingApplied: modelInputWidth !== currentImage.naturalWidth || modelInputHeight !== currentImage.naturalHeight,
								scaleFactors: {
									x: currentImage.naturalWidth / modelInputWidth,
									y: currentImage.naturalHeight / modelInputHeight
								}
							});
							
							// æ·»åŠ æ ‡ç­¾
							const label = document.createElement('div');
							label.className = 'detection-label';
							label.textContent = `${detection.package_type} (${(detection.confidence * 100).toFixed(1)}%)`;
							detectionBox.appendChild(label);
							
							selectionOverlay.appendChild(detectionBox);
							drawnBoxes++;
						} else {
							console.warn(`æ£€æµ‹æ¡† ${index} è¶…å‡ºå›¾ç‰‡è¾¹ç•Œï¼Œè·³è¿‡ç»˜åˆ¶:`, {
								calculated: { left, top, width, height },
								imageBounds: { offsetX, offsetY, maxLeft, maxTop }
							});
						}
					}
				});
				
				console.log(`æˆåŠŸç»˜åˆ¶ ${drawnBoxes} ä¸ªæ£€æµ‹æ¡†`);
				
				// ä¿å­˜æ£€æµ‹æ¡†åˆ°imageSelections
				const imageKey = `image_${currentImageIndex}`;
				const selections = [];
				
				// æ”¶é›†æ‰€æœ‰æ£€æµ‹æ¡†çš„ä¿¡æ¯
				const detectionBoxes = selectionOverlay.querySelectorAll('.detection-box');
				detectionBoxes.forEach(box => {
					const label = box.querySelector('.detection-label');
					selections.push({
						type: 'detection',
						left: box.style.left,
						top: box.style.top,
						width: box.style.width,
						height: box.style.height,
						labelText: label ? label.textContent : ''
					});
				});
				
				imageSelections[imageKey] = selections;
				console.log(`ä¿å­˜å›¾ç‰‡ ${currentImageIndex + 1} çš„æ£€æµ‹æ¡†é€‰çŠ¶æ€:`, selections);
				
				// æ›´æ–°æŒ‰é’®çŠ¶æ€
				updateButtons();
				}
				
				// å¦‚æœå›¾åƒå·²ç»åŠ è½½ï¼Œç›´æ¥æ‰§è¡Œ
				if (currentImage.complete && currentImage.naturalWidth > 0) {
					console.log('å›¾åƒå·²åŠ è½½ï¼Œç›´æ¥ç»˜åˆ¶');
					drawBoxes();
				} else {
					console.log('ç­‰å¾…å›¾åƒåŠ è½½å®Œæˆ');
					// ç­‰å¾…å›¾åƒåŠ è½½å®Œæˆ
					currentImage.onload = drawBoxes;
				}
			}

			/**
			 * æå–ä¿¡æ¯
			 */
			async function extractInfo() {
				if (!selectionBox || selectionBox.style.display === 'none') {
					eda.sys_ToastMessage.showMessage('è¯·å…ˆæ¡†é€‰è¦æå–çš„åŒºåŸŸ', 2);
					return;
				}
				
				// æ£€æŸ¥è®¾ç½®æ˜¯å¦å®Œæ•´
				if (!isSpecialApiFormat(selectedProvider, apiUrl) && (!apiKey || apiKey.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥', 0);
					return;
				}
				
				if (selectedProvider === 'custom' && (!apiUrl || apiUrl.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰APIåœ°å€', 0);
					return;
				}
				
				if (selectedProvider === 'custom' && (!customModel || customModel.trim() === '')) {
					eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰æ¨¡å‹åç§°', 0);
					return;
				}
				
				try {
				const currentImage = currentImages[currentImageIndex];
			
			// å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64æ ¼å¼
			const canvas = document.createElement('canvas');
			const ctx = canvas.getContext('2d');
			const img = new Image();
			
			img.onload = async function() {
				canvas.width = img.width;
				canvas.height = img.height;
				ctx.drawImage(img, 0, 0);
				
				const base64Data = canvas.toDataURL('image/png').split(',')[1];
				// ä½¿ç”¨å¤šå›¾æ¨¡å¼ï¼Œä¼ å…¥å•å¼ å›¾ç‰‡çš„æ•°ç»„
				const result = await analyzeImage([currentImage.file], [base64Data], ['png']);
				
				// è§£æè¿”å›çš„JSONæ•°æ®å¹¶æ·»åŠ åˆ°è¡¨æ ¼
				parseAndAddPins(result.result);
				
				eda.sys_ToastMessage.showMessage('ä¿¡æ¯æå–æˆåŠŸ', 1);
			};
			
			img.onerror = function() {
				eda.sys_ToastMessage.showMessage('å›¾ç‰‡åŠ è½½å¤±è´¥', 0);
			};
			
			img.src = currentImage.src;
			} catch (error) {
				console.error('æå–ä¿¡æ¯å¤±è´¥:', error);
				eda.sys_ToastMessage.showMessage('æå–ä¿¡æ¯å¤±è´¥: ' + error.message, 0);
			}
			}

			/**
			 * æ›´æ–°æŒ‰é’®çŠ¶æ€
			 */
			function updateButtons() {
				// æœç´¢ä½ç½®æŒ‰é’®ï¼šæœ‰å›¾ç‰‡æ—¶å¯ç”¨
				searchPositionButton.disabled = currentImages.length === 0;
				
				// æå–å‚æ•°æŒ‰é’®ï¼šæœ‰æ¡†é€‰ï¼ˆæ‰‹åŠ¨æ¡†é€‰æˆ–æœç´¢ä½ç½®çš„è‡ªåŠ¨æ¡†é€‰ï¼‰æ—¶å¯ç”¨
				let hasSelections = false;
				for (let i = 0; i < currentImages.length; i++) {
					const imageKey = `image_${i}`;
					const selections = imageSelections[imageKey];
					if (selections && selections.length > 0) {
						hasSelections = true;
						break;
					}
				}
				extractParamsButton.disabled = !hasSelections;
				
				// æ‰‹åŠ¨æ¡†é€‰æŒ‰é’®ï¼šæœ‰å›¾ç‰‡æ—¶å¯ç”¨
				manualSelectButton.disabled = currentImages.length === 0;
				
				// æ¸…é™¤æ¡†é€‰æŒ‰é’®ï¼šæœ‰å›¾ç‰‡æ—¶å¯ç”¨
				clearSelectionButton.disabled = currentImages.length === 0;
				
				// åˆ›å»ºç¬¦å·æŒ‰é’®ï¼šæœ‰å¼•è„šæ•°æ®æ—¶å¯ç”¨
			createSymbolButton.disabled = pinData.length === 0;
			
			// å¤åˆ¶ç¬¦å·ä¿¡æ¯æŒ‰é’®ï¼šæœ‰å¼•è„šæ•°æ®æ—¶å¯ç”¨
			copySymbolInfoButton.disabled = pinData.length === 0;
			}
			
			/**
			 * æ›´æ–°UIçŠ¶æ€
			 */
			function updateUI() {
				updateButtons();
			}

			/**
			 * æ·»åŠ å¼•è„š
			 */
			function addPin() {
				const newPin = {
					pinNumber: pinData.length + 1,
					pinName: '',
					pinType: 'æœªå®šä¹‰',
					description: ''
				};
				
				pinData.push(newPin);
				updatePinTable();
				updateUI();
			}

			/**
			 * æ¸…ç©ºè¡¨æ ¼
			 */
			function clearTable() {
				pinData = [];
				updatePinTable();
				updateUI();
			}

			/**
			 * æ›´æ–°å¼•è„šè¡¨æ ¼
			 */
			function updatePinTable() {
				if (pinData.length === 0) {
					pinTableContainer.innerHTML = '<div class="empty-state">æš‚æ— å¼•è„šä¿¡æ¯</div>';
					return;
				}
				
				let tableHTML = `
					<table class="pin-table">
						<thead>
							<tr>
								<th>å¼•è„šå·</th>
								<th>å¼•è„šå</th>
								<th>ç±»å‹</th>
								<th>æ“ä½œ</th>
							</tr>
						</thead>
						<tbody>
				`;
				
				pinData.forEach((pin, index) => {
					tableHTML += `
						<tr>
							<td><input type="text" value="${pin.pinNumber}" onchange="updatePin(${index}, 'pinNumber', this.value)"></td>
							<td><input type="text" value="${pin.pinName}" onchange="updatePin(${index}, 'pinName', this.value)"></td>
							<td>
								<select onchange="updatePin(${index}, 'pinType', this.value)">
									<option value="æœªå®šä¹‰" ${pin.pinType === 'æœªå®šä¹‰' ? 'selected' : ''}>æœªå®šä¹‰</option>
									<option value="åŒå‘" ${pin.pinType === 'åŒå‘' ? 'selected' : ''}>åŒå‘</option>
									<option value="åœ°" ${pin.pinType === 'åœ°' ? 'selected' : ''}>åœ°</option>
									<option value="é«˜é˜»" ${pin.pinType === 'é«˜é˜»' ? 'selected' : ''}>é«˜é˜»</option>
									<option value="è¾“å…¥" ${pin.pinType === 'è¾“å…¥' ? 'selected' : ''}>è¾“å…¥</option>
									<option value="å¼€é›†ç”µæ" ${pin.pinType === 'å¼€é›†ç”µæ' ? 'selected' : ''}>å¼€é›†ç”µæ</option>
									<option value="å¼€å‘å°„æ" ${pin.pinType === 'å¼€å‘å°„æ' ? 'selected' : ''}>å¼€å‘å°„æ</option>
									<option value="è¾“å‡º" ${pin.pinType === 'è¾“å‡º' ? 'selected' : ''}>è¾“å‡º</option>
									<option value="æ— æº" ${pin.pinType === 'æ— æº' ? 'selected' : ''}>æ— æº</option>
									<option value="ç”µæº" ${pin.pinType === 'ç”µæº' ? 'selected' : ''}>ç”µæº</option>
									<option value="ä¿¡å·ç»ˆç«¯" ${pin.pinType === 'ä¿¡å·ç»ˆç«¯' ? 'selected' : ''}>ä¿¡å·ç»ˆç«¯</option>
								</select>
							</td>
							<td><button onclick="removePin(${index})">åˆ é™¤</button></td>
						</tr>
					`;
				});
				
				tableHTML += `
						</tbody>
					</table>
				`;
				
				pinTableContainer.innerHTML = tableHTML;
			}

			/**
			 * æ›´æ–°å¼•è„šæ•°æ®
			 */
			function updatePin(index, field, value) {
				if (pinData[index]) {
					pinData[index][field] = value;
				}
			}

			/**
			 * åˆ é™¤å¼•è„š
			 */
			function removePin(index) {
				pinData.splice(index, 1);
				updatePinTable();
				updateUI();
			}

			/**
			 * åœæ­¢åˆ†æè¿‡ç¨‹
			 */
			function stopAnalysis() {
				if (!isProcessing) return;
				shouldStopProcessing = true;
				stopButton.disabled = true;
				stopButton.textContent = 'æ­£åœ¨åœæ­¢...';
			}

			/**
			 * å¼€å§‹åˆ†æå›¾ç‰‡
			 */
			async function startAnalysis() {
				// è·å–å½“å‰APIå¯†é’¥å’Œæ¨¡å‹
				eda.sys_ToastMessage.showMessage('å›¾ç‰‡è¯†åˆ«æ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰å¾…æœŸé—´å¯é€‰æ‹©éšè—çª—å£', 3);
				// æ£€æŸ¥è®¾ç½®æ˜¯å¦å®Œæ•´
			if (!isSpecialApiFormat(selectedProvider, apiUrl) && (!apiKey || apiKey.trim() === '')) {
				eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥', 0);
				return;
			}
			
			if (selectedProvider === 'custom' && (!apiUrl || apiUrl.trim() === '')) {
				eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰APIåœ°å€', 0);
				return;
			}
			
			if (selectedProvider === 'custom' && (!customModel || customModel.trim() === '')) {
				eda.sys_ToastMessage.showMessage('è¯·åœ¨è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰æ¨¡å‹åç§°', 0);
				return;
			}
				if (uploadedFiles.length === 0 || isProcessing) {
					return;
				}

				isProcessing = true;
				updateUI();
				progressContainer.style.display = 'block';
				progressBar.style.width = '0%';
				progressText.textContent = `å¤„ç†ä¸­: 0/${uploadedFiles.length}`;
				resultsList.innerHTML = '';
				analysisResults = [];
				totalInputTokens = 0;
				totalOutputTokens = 0;
				costContainer.style.display = 'none';
				startTime = Date.now();

				setInterval(() => {
					const elapsedTime = Date.now() - startTime;
					const minutes = Math.floor(elapsedTime / 60000);
					const seconds = Math.floor((elapsedTime % 60000) / 1000);
					timerElement.textContent = `å·²ç”¨æ—¶: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
				}, 1000);

				try {
				if (shouldStopProcessing) {
					progressText.textContent = `å·²åœæ­¢: 0/${uploadedFiles.length}`;
					return;
				}

				// å‡†å¤‡æ‰€æœ‰æ–‡ä»¶çš„base64æ•°æ®
				progressText.textContent = 'æ­£åœ¨å‡†å¤‡å›¾ç‰‡æ•°æ®...';
				const base64Images = [];
				const mimeTypes = [];
				
				for (let i = 0; i < uploadedFiles.length; i++) {
					const file = uploadedFiles[i];
					const base64Data = await readFileAsBase64(file);
					base64Images.push(base64Data);
					mimeTypes.push(file.type.split('/')[1] || 'png');
					
					const progress = Math.round(((i + 1) / uploadedFiles.length) * 50); // å‰50%ç”¨äºå‡†å¤‡æ•°æ®
					progressBar.style.width = `${progress}%`;
					progressText.textContent = `å‡†å¤‡å›¾ç‰‡æ•°æ®: ${i + 1}/${uploadedFiles.length}`;
				}

				if (shouldStopProcessing) return;

				// ä¸€æ¬¡æ€§è°ƒç”¨APIå¤„ç†æ‰€æœ‰å›¾ç‰‡
				progressBar.style.width = '75%';
				progressText.textContent = 'æ­£åœ¨è°ƒç”¨AIåˆ†æ...';
				
				const resultData = await analyzeImage(uploadedFiles, base64Images, mimeTypes);
				
				// å¤„ç†ç»“æœ
				for (let i = 0; i < uploadedFiles.length; i++) {
					const file = uploadedFiles[i];
					analysisResults.push({
						filename: file.name,
						result: resultData.result,
						inputTokens: resultData.inputTokens,
						outputTokens: resultData.outputTokens,
						base64: base64Images[i],
						file: file,
						index: i,
						isError: false,
					});
					displayResult(file, base64Images[i], resultData.result);
				}
				
				calculateAndUpdateCost(selectedModel, resultData.inputTokens, resultData.outputTokens);
				
			} catch (error) {
				console.error('æ‰¹é‡å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
				if (shouldStopProcessing) return;
				
				// å¦‚æœæ‰¹é‡å¤„ç†å¤±è´¥ï¼Œè®°å½•é”™è¯¯
				for (let i = 0; i < uploadedFiles.length; i++) {
					const file = uploadedFiles[i];
					analysisResults.push({
						filename: file.name,
						errorMessage: error.message,
						inputTokens: 0,
						outputTokens: 0,
						file: file,
						index: i,
						isError: true,
					});
					displayError(file, error.message);
				}
			}

				const processedCount = shouldStopProcessing ? analysisResults.length : uploadedFiles.length;
				progressBar.style.width = '100%';
				progressText.textContent = `å¤„ç†å®Œæˆ: ${processedCount}/${uploadedFiles.length}`;
				setTimeout(() => {
					progressContainer.style.display = 'none';
					progressBar.style.width = '0%';
				}, 2000);

				if (analysisResults.length > 0) {
					downloadAllContainer.style.display = 'block';
				}

				setTimeout(() => {
					isProcessing = false;
					shouldStopProcessing = false;
					updateUI();
				}, 1000);
			}

			/**
			 * è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºBase64
			 */
			function readFileAsBase64(file) {
				return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = function (e) {
						const base64 = e.target.result.split(',')[1];
						resolve(base64);
					};
					reader.onerror = function (e) {
						reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
					};
					reader.readAsDataURL(file);
				});
			}

			/**
			 * è°ƒç”¨APIåˆ†æå›¾ç‰‡ï¼ˆæ”¯æŒå¤šå›¾æ‰¹é‡å¤„ç†ï¼‰
			 */
			async function analyzeImage(files, base64Images, mimeTypes) {
				if (shouldStopProcessing) {
					throw new Error('ç”¨æˆ·å·²åœæ­¢å¤„ç†');
				}

				// æ„å»ºå¤šå›¾å†…å®¹æ•°ç»„
				const imageContents = [];
				for (let i = 0; i < base64Images.length; i++) {
					imageContents.push({
						type: 'image_url',
						image_url: {
							url: `data:image/${mimeTypes[i]};base64,${base64Images[i]}`,
						},
					});
				}
				
				// æ·»åŠ æ–‡æœ¬æç¤º
				imageContents.push({
					type: 'text',
					text: "ä»èŠ¯ç‰‡å°è£…æ‰‹å†Œçš„ç¬¦å·å›¾ä¸­æå–ä»¥ä¸‹ä¿¡æ¯:{['type'],['pinNumber','pinName',]}ï¼Œå›¾åƒ type åŒ…æ‹¬:SOPã€QFNã€BGAã€‚ä¸¥æ ¼è¾“å‡ºJSON",
				});
				
				const data = {
					model: selectedModel,
					vl_high_resolution_images: true,
					messages: [
						{
							role: 'system',
							content: [{ type: 'text', text: 'You are a helpful assistant.' }],
						},
						{
							role: 'user',
							content: imageContents,
						},
					],
				};

				try {
				const response = await callAPI(data);

				if (!response.ok) {
					throw new Error('APIè¯·æ±‚å¤±è´¥');
				}

				let result, content;
				
				if (isSpecialApiFormat(selectedProvider, apiUrl)) {
					// è‡ªå®šä¹‰æ¨¡å¼ä½¿ç”¨ç‰¹æ®ŠAPIå“åº”å¤„ç†
			const responseText = await response.text();
			console.log('ç‰¹æ®ŠAPIåŸå§‹å“åº”:', responseText);
			
			// é¦–å…ˆå°è¯•ç›´æ¥è§£æä¸ºJSONï¼ˆç‰¹æ®ŠAPIå¯èƒ½ç›´æ¥è¿”å›JSONæ ¼å¼ï¼‰
			try {
				result = JSON.parse(responseText);
				console.log('ç‰¹æ®ŠAPIå“åº”è§£ææˆåŠŸ:', result);
				
				// å¦‚æœç›´æ¥è§£ææˆåŠŸä¸”åŒ…å«pinsæ•°ç»„ï¼Œç›´æ¥è¿”å›
				if (result.pins && Array.isArray(result.pins)) {
					console.log('ç‰¹æ®ŠAPIç›´æ¥è¿”å›äº†pinsæ•°ç»„');
						return {
							result: JSON.stringify(result),
							inputTokens: 0,
							outputTokens: 0
						};
					}
					
					// å¦åˆ™æŒ‰ç…§åŸæœ‰é€»è¾‘å¤„ç†
					if (result.context && result.context.chat && result.context.chat.input_text) {
						content = result.context.chat.input_text;
					} else if (result.data && result.data.content) {
						content = result.data.content;
					} else if (result.content) {
						content = result.content;
					} else if (result.response) {
						content = result.response;
					} else {
						// å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å°†æ•´ä¸ªresultä½œä¸ºå†…å®¹
						content = JSON.stringify(result);
						console.log('ä½¿ç”¨æ•´ä¸ªresultä½œä¸ºå†…å®¹:', content);
					}
				} catch (parseError) {
					// å¦‚æœJSONè§£æå¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬
					console.log('ç‰¹æ®ŠAPIå“åº”ä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬:', responseText);
					content = responseText;
				}
				
				return {
					result: content,
					inputTokens: 0, // ç‰¹æ®ŠAPIå¯èƒ½ä¸è¿”å›tokenä¿¡æ¯
					outputTokens: 0
				};
				} else {
					// é€šä¹‰åƒé—®ã€æ™ºè°±AIå’Œè‡ªå®šä¹‰APIå“åº”å¤„ç†
					result = await response.json();
					
					if (selectedProvider === 'zhipu') {
						// æ™ºè°±AIå“åº”æ ¼å¼
						return {
							result: result.choices[0].message.content,
							inputTokens: result.usage?.prompt_tokens || 0,
							outputTokens: result.usage?.completion_tokens || 0,
						};
					} else if (selectedProvider === 'qwen') {
						// é€šä¹‰åƒé—®å…¼å®¹æ¨¡å¼å“åº”æ ¼å¼
						return {
							result: result.choices[0].message.content,
							inputTokens: result.usage?.prompt_tokens || 0,
							outputTokens: result.usage?.completion_tokens || 0,
						};
					} else {
						// è‡ªå®šä¹‰APIå“åº”æ ¼å¼
						return {
							result: result.choices[0].message.content,
							inputTokens: result.usage?.prompt_tokens || 0,
							outputTokens: result.usage?.completion_tokens || 0,
						};
					}
				}
			} catch (error) {
				throw new Error('APIè°ƒç”¨å¤±è´¥');
			}
			}

			/**
			 * æ˜¾ç¤ºåˆ†æç»“æœ
			 */
			function displayResult(file, base64, result) {
				const resultCard = document.createElement('div');
				resultCard.className = 'result-card';

				const header = document.createElement('div');
				header.className = 'result-card-header';
				const title = document.createElement('div');
				title.className = 'result-card-title';
				title.textContent = file.name;
				const toggleBtn = document.createElement('button');
				toggleBtn.textContent = 'å±•å¼€';
				toggleBtn.addEventListener('click', () => {
					const content = resultCard.querySelector('.result-card-content');
					if (content.style.display === 'none' || content.style.display === '') {
						content.style.display = 'block';
						toggleBtn.textContent = 'æ”¶èµ·';
					} else {
						content.style.display = 'none';
						toggleBtn.textContent = 'å±•å¼€';
					}
				});
				header.appendChild(title);
				header.appendChild(toggleBtn);

				const content = document.createElement('div');
				content.className = 'result-card-content';
				content.textContent = result;

				const footer = document.createElement('div');
				footer.className = 'result-card-footer';
				const copyBtn = document.createElement('button');
				copyBtn.textContent = 'å¤åˆ¶ç»“æœ';
				copyBtn.addEventListener('click', () => {
					navigator.clipboard
						.writeText(result)
						.then(() => {
							copyBtn.textContent = 'å·²å¤åˆ¶';
							setTimeout(() => {
								copyBtn.textContent = 'å¤åˆ¶ç»“æœ';
							}, 2000);
						})
						.catch((err) => {
							console.error('å¤åˆ¶å¤±è´¥:', err);
							eda.sys_ToastMessage.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 0);
						});
				});
				const createSymbolBtn = document.createElement('button');
				createSymbolBtn.className = 'create-symbol-btn';
				createSymbolBtn.textContent = 'åˆ›å»ºç¬¦å·';
				createSymbolBtn.addEventListener('click', () => {
					createSymbol(result);
				});
				footer.appendChild(copyBtn);
				footer.appendChild(createSymbolBtn);

				resultCard.appendChild(header);
				resultCard.appendChild(content);
				resultCard.appendChild(footer);

				resultsList.appendChild(resultCard);
			}

			/**
			 * æ˜¾ç¤ºé”™è¯¯ç»“æœ
			 */
			function displayError(file, errorMessage) {
				const resultCard = document.createElement('div');
				resultCard.className = 'result-card error';

				const header = document.createElement('div');
				header.className = 'result-card-header';
				const title = document.createElement('div');
				title.className = 'result-card-title';
				title.textContent = file.name;
				const toggleBtn = document.createElement('button');
				toggleBtn.textContent = 'å±•å¼€';
				toggleBtn.addEventListener('click', () => {
					const content = resultCard.querySelector('.result-card-content');
					if (content.style.display === 'none' || content.style.display === '') {
						content.style.display = 'block';
						toggleBtn.textContent = 'æ”¶èµ·';
					} else {
						content.style.display = 'none';
						toggleBtn.textContent = 'å±•å¼€';
					}
				});
				header.appendChild(title);
				header.appendChild(toggleBtn);

				const content = document.createElement('div');
				content.className = 'result-card-content';
				content.textContent = `å¤„ç†å¤±è´¥: ${errorMessage}`;

				resultCard.appendChild(header);
				resultCard.appendChild(content);

				resultsList.appendChild(resultCard);
			}



			/**
			 * ä¸‹è½½æ‰€æœ‰ç»“æœ
			 */
			function downloadAllResults() {
				if (analysisResults.length === 0) {
					eda.sys_ToastMessage.showMessage('æ²¡æœ‰å¯ä¸‹è½½çš„ç»“æœ', 2);
					return;
				}

				const zip = new JSZip();
				analysisResults.forEach((result) => {
					const filename = `${result.filename.split('.')[0]}.txt`;
					zip.file(filename, result.result);
				});

				zip.generateAsync({ type: 'blob' })
					.then((blob) => {
						const link = document.createElement('a');
						link.href = URL.createObjectURL(blob);
						const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
						link.download = `å›¾ç‰‡åˆ†æç»“æœ_${timestamp}.zip`;
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
						setTimeout(() => URL.revokeObjectURL(link.href), 100);
					})
					.catch((err) => {
						console.error('åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥:', err);
						eda.sys_ToastMessage.showMessage('åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥ï¼Œå°†é€ä¸ªä¸‹è½½ç»“æœ', 2);
						analysisResults.forEach((result) => {
							downloadResult(result.filename, result.result);
						});
					});
			}

			/**
			 * ä¸‹è½½å•ä¸ªç»“æœ
			 */
			function downloadResult(filename, content) {
				const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
				const link = document.createElement('a');
				link.href = URL.createObjectURL(blob);
				link.download = `${filename.split('.')[0]}.txt`;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				setTimeout(() => URL.revokeObjectURL(link.href), 100);
			}

			/**
			 * è®¡ç®—è´¹ç”¨å¹¶æ›´æ–°UI
			 */
			function calculateAndUpdateCost(model, inputTokens, outputTokens) {
				totalInputTokens += inputTokens;
				totalOutputTokens += outputTokens;
				const rates = modelRates[model] || modelRates['qwen-vl-max-latest'];
				const inputCost = (totalInputTokens / 1000) * rates.input;
				const outputCost = (totalOutputTokens / 1000) * rates.output;
				const totalCost = inputCost + outputCost;
				inputTokensElement.textContent = totalInputTokens;
				outputTokensElement.textContent = totalOutputTokens;
				inputCostElement.textContent = `Â¥${inputCost.toFixed(4)}`;
				outputCostElement.textContent = `Â¥${outputCost.toFixed(4)}`;
				totalCostElement.textContent = `Â¥${totalCost.toFixed(4)}`;
				costContainer.style.display = 'block';
			}

			/**
			 * è§£æå¹¶æ·»åŠ å¼•è„šæ•°æ®
			 */
			function parseAndAddPins(resultText) {
				try {
					console.log('å¼€å§‹è§£æå¼•è„šæ•°æ®ï¼ŒåŸå§‹å†…å®¹:', resultText);
					
					// æ™ºè°±AIç‰¹æ®Šæ ‡è®°å¤„ç†
					if (selectedProvider === 'zhipu') {
						// æå–<|begin_of_box|>å’Œ<|end_of_box|>ä¹‹é—´çš„å†…å®¹
						const boxMatch = resultText.match(/<\|begin_of_box\|>([\s\S]*?)<\|end_of_box\|>/);
						if (boxMatch) {
							resultText = boxMatch[1].trim();
							console.log('æ™ºè°±AIæå–çš„JSONå†…å®¹:', resultText);
						}
					}
					
					// æ–¹æ³•1: ä¼˜å…ˆå°è¯•è§£æå®Œæ•´çš„JSONå­—ç¬¦ä¸²ï¼ˆå¤„ç†è‡ªå®šä¹‰APIç›´æ¥è¿”å›çš„JSONæ ¼å¼ï¼‰
					try {
						// å°è¯•å°†æ•´ä¸ªresultTextä½œä¸ºJSONè§£æ
						let fullJsonData = null;
						
						// é¦–å…ˆå°è¯•ç›´æ¥è§£æ
						try {
							fullJsonData = JSON.parse(resultText.trim());
							console.log('ç›´æ¥è§£æJSONæˆåŠŸ');
						} catch (directError) {
							// å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æå–JSONéƒ¨åˆ†
							const trimmedText = resultText.trim();
							const firstBrace = trimmedText.indexOf('{');
							const lastBrace = trimmedText.lastIndexOf('}');
							
							if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
								const jsonPart = trimmedText.substring(firstBrace, lastBrace + 1);
								try {
									fullJsonData = JSON.parse(jsonPart);
									console.log('æˆåŠŸè§£ææå–çš„JSONéƒ¨åˆ†');
								} catch (extractError) {
									console.warn('æå–JSONéƒ¨åˆ†è§£æå¤±è´¥:', extractError.message);
								}
							}
						}
						
						if (fullJsonData && fullJsonData.pins && Array.isArray(fullJsonData.pins)) {
							console.log('é€šè¿‡å®Œæ•´JSONè§£ææ‰¾åˆ°pinsæ•°ç»„ï¼Œé•¿åº¦:', fullJsonData.pins.length);
							
							fullJsonData.pins.forEach((pin, index) => {
								try {
									// æ›´å¼ºçš„å®¹é”™å¤„ç†ï¼Œæ”¯æŒå„ç§å¯èƒ½çš„å­—æ®µå
									const pinNumber = String(pin.pinNumber || pin.pin_number || pin.number || pin.pin || (index + 1));
									const pinName = String(pin.pinName || pin.pin_name || pin.name || pin.label || `Pin${pinNumber}`);
									
									// ç¡®ä¿å¼•è„šåç§°ä¸ä¸ºç©ºä¸”å¤„ç†ç‰¹æ®Šå­—ç¬¦
									const cleanPinName = pinName.trim() || `Pin${pinNumber}`;
									
									pinData.push({
										pinNumber: pinNumber,
										pinName: cleanPinName,
										pinType: pin.pinType || pin.pin_type || pin.type || 'I/O',
										description: pin.description || pin.desc || pin.comment || ''
									});
									
									console.log(`æˆåŠŸå¤„ç†å¼•è„š ${pinNumber}: ${cleanPinName}`);
								} catch (pinError) {
									console.warn(`å¤„ç†å¼•è„š ${index} æ—¶å‡ºé”™:`, pinError, pin);
									// å³ä½¿å•ä¸ªå¼•è„šå¤„ç†å¤±è´¥ï¼Œä¹Ÿå°è¯•æ·»åŠ åŸºæœ¬ä¿¡æ¯
									try {
										pinData.push({
													pinNumber: `Pin${index + 1}`,
													pinName: `Pin${index + 1}`,
													pinType: 'æœªå®šä¹‰',
													description: 'è§£æå¤±è´¥çš„å¼•è„š'
												});
									} catch (fallbackError) {
										console.error('è¿å¤‡ç”¨å¼•è„šä¿¡æ¯éƒ½æ— æ³•æ·»åŠ :', fallbackError);
									}
								}
							});
							
							updatePinTable();
							updateUI();
							eda.sys_ToastMessage.showMessage(`æˆåŠŸè§£æ ${fullJsonData.pins.length} ä¸ªå¼•è„šä¿¡æ¯`, 1);
							return;
						}
					} catch (fullJsonError) {
						console.warn('å®Œæ•´JSONè§£æå¤±è´¥:', fullJsonError.message);
					}
					
					// æ–¹æ³•2: å°è¯•è§£ææ ‡å‡†çš„```jsonä»£ç å—
					const jsonMatches = resultText.match(/```json\s*([\s\S]*?)\s*```/g);
					if (jsonMatches && jsonMatches.length > 0) {
						console.log('æ‰¾åˆ°JSONä»£ç å—ï¼Œæ•°é‡:', jsonMatches.length);
						
						// éå†æ‰€æœ‰JSONä»£ç å—ï¼Œå¯»æ‰¾åŒ…å«pinsæ•°ç»„çš„
						for (const jsonBlock of jsonMatches) {
							try {
								const jsonContent = jsonBlock.replace(/```json\s*/, '').replace(/\s*```$/, '');
								const jsonData = JSON.parse(jsonContent);
								
								if (jsonData.pins && Array.isArray(jsonData.pins)) {
									console.log('æ‰¾åˆ°æœ‰æ•ˆçš„pinsæ•°ç»„ï¼Œé•¿åº¦:', jsonData.pins.length);
									jsonData.pins.forEach(pin => {
										pinData.push({
											pinNumber: pin.pin_number || pin.pinNumber || '',
											pinName: pin.pin_name || pin.pinName || '',
											pinType: pin.pin_type || pin.pinType || pin.type || 'æœªå®šä¹‰',
											description: pin.description || ''
										});
									});
									updatePinTable();
									updateUI();
									eda.sys_ToastMessage.showMessage(`æˆåŠŸè§£æ ${jsonData.pins.length} ä¸ªå¼•è„šä¿¡æ¯`, 1);
									return;
								}
							} catch (parseError) {
								console.warn('è§£æJSONä»£ç å—å¤±è´¥:', parseError);
								continue;
							}
						}
					}
					
					// æ–¹æ³•2: å°è¯•ç›´æ¥æŸ¥æ‰¾JSONå¯¹è±¡ï¼ˆä¸åœ¨ä»£ç å—ä¸­ï¼‰
				// æ”¹è¿›çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œèƒ½æ›´å¥½åœ°åŒ¹é…å®Œæ•´çš„JSONå¯¹è±¡
				let directJsonMatch = null;
				
				// é¦–å…ˆå°è¯•åŒ¹é…å®Œæ•´çš„JSONå¯¹è±¡
				const jsonStartIndex = resultText.indexOf('{');
				if (jsonStartIndex !== -1) {
					// ä»ç¬¬ä¸€ä¸ª{å¼€å§‹ï¼Œæ‰¾åˆ°åŒ¹é…çš„}
					let braceCount = 0;
					let jsonEndIndex = -1;
					
					for (let i = jsonStartIndex; i < resultText.length; i++) {
						if (resultText[i] === '{') {
							braceCount++;
						} else if (resultText[i] === '}') {
							braceCount--;
							if (braceCount === 0) {
								jsonEndIndex = i;
								break;
							}
						}
					}
					
					if (jsonEndIndex !== -1) {
						const jsonStr = resultText.substring(jsonStartIndex, jsonEndIndex + 1);
						if (jsonStr.includes('"pins"')) {
							directJsonMatch = [jsonStr];
						}
					}
				}
				
				// å¦‚æœä¸Šé¢çš„æ–¹æ³•æ²¡æ‰¾åˆ°ï¼Œå›é€€åˆ°åŸæ¥çš„æ­£åˆ™è¡¨è¾¾å¼æ–¹æ³•
				if (!directJsonMatch) {
					directJsonMatch = resultText.match(/\{[\s\S]*?"pins"[\s\S]*?\}/g);
				}
					if (directJsonMatch && directJsonMatch.length > 0) {
						console.log('æ‰¾åˆ°ç›´æ¥JSONå¯¹è±¡ï¼Œæ•°é‡:', directJsonMatch.length);
						
						for (const jsonStr of directJsonMatch) {
						try {
							// å°è¯•å¤šç§JSONè§£æç­–ç•¥
							let jsonData = null;
							
							// ç­–ç•¥1: ç›´æ¥è§£æ
							try {
								jsonData = JSON.parse(jsonStr);
							} catch (directParseError) {
								console.warn('ç›´æ¥JSONè§£æå¤±è´¥ï¼Œå°è¯•æ¸…ç†åè§£æ:', directParseError.message);
								
								// ç­–ç•¥2: æ¸…ç†å¸¸è§çš„JSONæ ¼å¼é—®é¢˜åè§£æ
								let cleanedJsonStr = jsonStr
									.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":') // ä¸ºæ²¡æœ‰å¼•å·çš„é”®æ·»åŠ å¼•å·
									.replace(/:\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*([,}])/g, ': "$1"$2') // ä¸ºæ²¡æœ‰å¼•å·çš„å­—ç¬¦ä¸²å€¼æ·»åŠ å¼•å·
									.replace(/,\s*}/g, '}') // ç§»é™¤å¤šä½™çš„é€—å·
									.replace(/,\s*]/g, ']'); // ç§»é™¤æ•°ç»„æœ«å°¾å¤šä½™çš„é€—å·
								
								try {
									jsonData = JSON.parse(cleanedJsonStr);
									console.log('æ¸…ç†åJSONè§£ææˆåŠŸ');
								} catch (cleanedParseError) {
									console.warn('æ¸…ç†åJSONè§£æä»ç„¶å¤±è´¥:', cleanedParseError.message);
									throw cleanedParseError;
								}
							}
							
							if (jsonData && jsonData.pins && Array.isArray(jsonData.pins)) {
								console.log('æ‰¾åˆ°æœ‰æ•ˆçš„pinsæ•°ç»„ï¼Œé•¿åº¦:', jsonData.pins.length);
								
								// å¤„ç†æ¯ä¸ªå¼•è„šï¼Œå¢å¼ºå®¹é”™æ€§
								jsonData.pins.forEach((pin, index) => {
									try {
										const pinNumber = String(pin.pin_number || pin.pinNumber || pin.number || (index + 1));
										const pinName = String(pin.pin_name || pin.pinName || pin.name || `Pin${pinNumber}`);
										
										pinData.push({
											pinNumber: pinNumber,
											pinName: pinName,
											pinType: pin.pin_type || pin.pinType || pin.type || 'I/O',
											description: pin.description || pin.desc || ''
										});
									} catch (pinError) {
										console.warn(`å¤„ç†å¼•è„š ${index} æ—¶å‡ºé”™:`, pinError, pin);
										// å³ä½¿å•ä¸ªå¼•è„šå¤„ç†å¤±è´¥ï¼Œä¹Ÿç»§ç»­å¤„ç†å…¶ä»–å¼•è„š
									}
								});
								
								updatePinTable();
								updateUI();
								eda.sys_ToastMessage.showMessage(`æˆåŠŸè§£æ ${jsonData.pins.length} ä¸ªå¼•è„šä¿¡æ¯`, 1);
								return;
							}
						} catch (parseError) {
							console.warn('è§£æç›´æ¥JSONå¤±è´¥:', parseError.message);
							console.warn('å¤±è´¥çš„JSONå­—ç¬¦ä¸²:', jsonStr.substring(0, 500) + (jsonStr.length > 500 ? '...' : ''));
							continue;
						}
					}
				}
				
				// æ–¹æ³•3: å°è¯•è§£ææ–‡æœ¬æ ¼å¼çš„å¼•è„šä¿¡æ¯
					console.log('å°è¯•è§£ææ–‡æœ¬æ ¼å¼çš„å¼•è„šä¿¡æ¯');
					const lines = resultText.split('\n');
					let foundPins = 0;
					
					lines.forEach(line => {
						// åŒ¹é… Pin X: NAME æ ¼å¼
						const pinMatch = line.match(/Pin\s*(\d+)\s*[:|ï¼š]\s*([^,ï¼Œ\n]+)/i);
						if (pinMatch) {
							pinData.push({
								pinNumber: pinMatch[1],
								pinName: pinMatch[2].trim(),
								pinType: 'æœªå®šä¹‰',
								description: ''
							});
							foundPins++;
							return;
						}
						
						// åŒ¹é… "pinNumber": "X", "pinName": "NAME" æ ¼å¼
						const jsonLineMatch = line.match(/"pinNumber"\s*:\s*"(\d+)".*?"pinName"\s*:\s*"([^"]+)"/);
						if (jsonLineMatch) {
							pinData.push({
							pinNumber: jsonLineMatch[1],
							pinName: jsonLineMatch[2].trim(),
							pinType: 'æœªå®šä¹‰',
							description: ''
						});
							foundPins++;
							return;
						}
						
						// åŒ¹é…æ•°å­—: åç§°æ ¼å¼
						const simpleMatch = line.match(/(\d+)\s*[:|ï¼š]\s*([^,ï¼Œ\n]+)/);
						if (simpleMatch) {
							pinData.push({
								pinNumber: simpleMatch[1],
								pinName: simpleMatch[2].trim(),
								pinType: 'æœªå®šä¹‰',
								description: ''
							});
							foundPins++;
						}
					});
					
					if (foundPins > 0) {
						console.log('é€šè¿‡æ–‡æœ¬è§£ææ‰¾åˆ°å¼•è„šæ•°é‡:', foundPins);
						updatePinTable();
						updateUI();
						eda.sys_ToastMessage.showMessage(`æˆåŠŸè§£æ ${foundPins} ä¸ªå¼•è„šä¿¡æ¯`, 1);
						return;
					}
					
					// å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†
					console.error('æ‰€æœ‰è§£ææ–¹æ³•éƒ½å¤±è´¥äº†');
					eda.sys_ToastMessage.showMessage('æ— æ³•è§£æå¼•è„šä¿¡æ¯ï¼Œè¯·æ£€æŸ¥APIè¿”å›æ ¼å¼', 0);
					
				} catch (error) {
					console.error('è§£æå¼•è„šæ•°æ®å¤±è´¥:', error);
					console.error('åŸå§‹å†…å®¹:', resultText);
					eda.sys_ToastMessage.showMessage('è§£æå¼•è„šæ•°æ®å¤±è´¥: ' + error.message, 0);
				}
			}

			/**
			 * åˆ›å»ºç¬¦å·ï¼ˆä»è¡¨æ ¼æ•°æ®ï¼‰
			 */
			function createSymbolFromTable() {
				if (pinData.length === 0) {
					eda.sys_ToastMessage.showMessage('è¯·å…ˆæ·»åŠ å¼•è„šä¿¡æ¯', 2);
					return;
				}
				
				try {
					// åˆ›å»ºç¬¦å·è¾¹æ¡†ï¼Œä¼ é€’å¼•è„šæ€»æ•°ï¼Œä½¿ç”¨å·¦å³ä¸¤è¾¹å¸ƒå±€
					let bbox = createSymbolBoundingBox('DUAL_SIDE', pinData.length);
					console.log('åˆ›å»ºçš„ç¬¦å·è¾¹æ¡†:', bbox);

					// åˆ›å»ºå¼•è„šï¼Œä½¿ç”¨å·¦å³ä¸¤è¾¹å¸ƒå±€
					createSymbolPins(pinData, bbox, 'DUAL_SIDE');
					console.log('å¼•è„šåˆ›å»ºå®Œæˆ');

					eda.sys_IFrame.hideIFrame('symbol');
					eda.sys_ToastMessage.showMessage('ç¬¦å·åˆ›å»ºæˆåŠŸï¼Œæ”¯æŒåœ¨èœå•ä¸­é€šè¿‡ç‚¹å‡»"ç»§ç»­åˆ›å»º"é€‰é¡¹ä»¥é‡æ–°æ‰“å¼€çª—å£', 3);
				} catch (error) {
					console.error('åˆ›å»ºç¬¦å·å¤±è´¥:', error);
					eda.sys_ToastMessage.showMessage('åˆ›å»ºç¬¦å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯', 0);
				}
			}

			/**
			 * å¤åˆ¶ç¬¦å·ä¿¡æ¯
			 */
			function copySymbolInfo() {
				if (pinData.length === 0) {
					if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
						eda.sys_ToastMessage.showMessage('æš‚æ— å¼•è„šä¿¡æ¯å¯å¤åˆ¶', 2);
					} else {
						alert('æš‚æ— å¼•è„šä¿¡æ¯å¯å¤åˆ¶');
					}
					return;
				}
				
				try {
					let copyText = '';
					
					pinData.forEach((pin, index) => {
						// æ¯ä¸ªå¼•è„šå ä¸€è¡Œï¼Œæ ¼å¼ä¸ºï¼šå¼•è„šå·\tå¼•è„šåç§°\t
						copyText += `${pin.pinNumber}\t${pin.pinName}\t\n`;
						
						// æ¯éš”å‡ ä¸ªå¼•è„šæ·»åŠ ç©ºè¡Œï¼ˆç”¨*è¡¨ç¤ºï¼‰
						if ((index + 1) % 4 === 0 && index < pinData.length - 1) {
							copyText += '*\t*\t\n';
						}
					});
					
					// å¤åˆ¶åˆ°å‰ªè´´æ¿
					navigator.clipboard.writeText(copyText).then(() => {
						if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
							eda.sys_ToastMessage.showMessage(`å·²å¤åˆ¶ ${pinData.length} ä¸ªå¼•è„šä¿¡æ¯åˆ°å‰ªè´´æ¿`, 1);
						} else {
							alert(`å·²å¤åˆ¶ ${pinData.length} ä¸ªå¼•è„šä¿¡æ¯åˆ°å‰ªè´´æ¿`);
						}
					}).catch(err => {
						console.error('å¤åˆ¶å¤±è´¥:', err);
						// é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿçš„å¤åˆ¶æ–¹æ³•
						const textArea = document.createElement('textarea');
						textArea.value = copyText;
						document.body.appendChild(textArea);
						textArea.select();
						try {
							document.execCommand('copy');
							if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
								eda.sys_ToastMessage.showMessage(`å·²å¤åˆ¶ ${pinData.length} ä¸ªå¼•è„šä¿¡æ¯åˆ°å‰ªè´´æ¿`, 1);
							} else {
								alert(`å·²å¤åˆ¶ ${pinData.length} ä¸ªå¼•è„šä¿¡æ¯åˆ°å‰ªè´´æ¿`);
							}
						} catch (fallbackErr) {
							console.error('é™çº§å¤åˆ¶ä¹Ÿå¤±è´¥:', fallbackErr);
							if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
								eda.sys_ToastMessage.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 0);
							} else {
								alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
							}
						}
						document.body.removeChild(textArea);
					});
					
				} catch (error) {
					console.error('å¤åˆ¶ç¬¦å·ä¿¡æ¯å¤±è´¥:', error);
					if (typeof eda !== 'undefined' && eda.sys_ToastMessage) {
						eda.sys_ToastMessage.showMessage('å¤åˆ¶å¤±è´¥: ' + error.message, 0);
					} else {
						alert('å¤åˆ¶å¤±è´¥: ' + error.message);
					}
				}
			}

			function createSymbol(jsonData) {
				try {
					// å»é™¤ä»£ç å—æ ‡è®°
					jsonData = jsonData.replace(/```json\n/, '').replace(/\n```$/, '');

					// å°è¯•è§£æJSONæ•°æ®
					const data = JSON.parse(jsonData);

					// æ£€æŸ¥JSONæ•°æ®æ˜¯å¦åŒ…å«å¿…è¦çš„å­—æ®µ
					if (!data || typeof data !== 'object' || !data.type || !Array.isArray(data.pins)) {
						throw new Error('JSONæ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘typeæˆ–pinså­—æ®µ');
					}

					const type = data.type;
					const pins = data.pins;

					console.log('è§£æçš„JSONæ•°æ®:', data);

					// åˆ›å»ºç¬¦å·è¾¹æ¡†ï¼Œä¼ é€’å¼•è„šæ€»æ•°
					let bbox = createSymbolBoundingBox(type, pins.length);
					console.log('åˆ›å»ºçš„ç¬¦å·è¾¹æ¡†:', bbox);

					console.log('type0', type);
					// åˆ›å»ºå¼•è„š
					createSymbolPins(pins, bbox, type);
					console.log('å¼•è„šåˆ›å»ºå®Œæˆ');

					eda.sys_IFrame.hideIFrame('symbol');
					eda.sys_ToastMessage.showMessage('ç¬¦å·åˆ›å»ºæˆåŠŸï¼Œæ”¯æŒåœ¨èœå•ä¸­é€šè¿‡ç‚¹å‡»â€œç»§ç»­åˆ›å»ºâ€é€‰é¡¹ä»¥é‡æ–°æ‰“å¼€çª—å£', 3);
				} catch (error) {
					console.error('åˆ›å»ºç¬¦å·å¤±è´¥:', error);
					eda.sys_ToastMessage.showMessage('åˆ›å»ºç¬¦å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯', 0);
				}
			}

			/**
			 * æ ¹æ®å¼•è„šæ€»æ•°é‡åŠ¨æ€åˆ›å»ºç¬¦å·è¾¹æ¡†
			 */
			function createSymbolBoundingBox(type, pinCount) {
				if (!pinCount || isNaN(pinCount) || pinCount <= 0) {
					throw new Error('æ— æ•ˆçš„å¼•è„šæ•°é‡: ' + pinCount);
				}

				let aspectRatio = 1.2;
				let width, height;
				const pinSpacing = 20; // æ¯ä¸ªå¼•è„šæ‰€éœ€çš„æœ€å°é—´è·

				if (type === 'SOP') {
					aspectRatio = 0.45;
					// æ ¹æ®å¼•è„šæ•°é‡è®¡ç®—å®½åº¦å’Œé«˜åº¦
					const totalPinsPerSide = Math.ceil(pinCount / 4); // æ¯è¾¹çš„å¼•è„šæ•°é‡
					width = totalPinsPerSide * pinSpacing * aspectRatio; // å®½åº¦ä¸å¼•è„šæ•°é‡æˆæ¯”ä¾‹
					height = totalPinsPerSide * pinSpacing; // é«˜åº¦ä¸å¼•è„šæ•°é‡æˆæ¯”ä¾‹
				} else if (type === 'DUAL_SIDE') {
					// å·¦å³ä¸¤è¾¹å¸ƒå±€ï¼šæ¯è¾¹åˆ†é…ä¸€åŠå¼•è„š
					const pinsPerSide = Math.ceil(pinCount / 2);
					height = (pinsPerSide + 1) * pinSpacing; // é«˜åº¦æ ¹æ®æ¯è¾¹å¼•è„šæ•°é‡è®¡ç®—
					width = height * 0.6; // å®½åº¦ç›¸å¯¹è¾ƒçª„
				} else {
					// é»˜è®¤å››è¾¹å¸ƒå±€
					const totalPinsPerSide = Math.ceil(pinCount / 4); // æ¯è¾¹çš„å¼•è„šæ•°é‡
					width = totalPinsPerSide * pinSpacing * aspectRatio; // å®½åº¦ä¸å¼•è„šæ•°é‡æˆæ¯”ä¾‹
					height = totalPinsPerSide * pinSpacing; // é«˜åº¦ä¸å¼•è„šæ•°é‡æˆæ¯”ä¾‹
				}

				// åˆ›å»ºè¾¹æ¡†çš„ç‚¹åæ ‡
				const bbox = [0, 0, width, 0, width, height, 0, height, 0, 0];

				// ä½¿ç”¨ eda.sch_PrimitivePolygon.create åˆ›å»ºç¬¦å·è¾¹æ¡†
				eda.sch_PrimitivePolygon.create(bbox);

				// éªŒè¯ bbox æ˜¯å¦æœ‰æ•ˆ
				if (bbox.some((value) => isNaN(value))) {
					throw new Error('ç”Ÿæˆçš„è¾¹æ¡†åæ ‡æ— æ•ˆ: ' + bbox);
				}

				return bbox;
			}

			/**
			 * å¼•è„šç±»å‹æ˜ å°„å‡½æ•°
			 * å°†ä¸­æ–‡å¼•è„šç±»å‹æ˜ å°„ä¸ºEDAç³»ç»Ÿçš„å¼•è„šç±»å‹æšä¸¾å€¼
			 */
			function mapPinType(chineseType) {
				const pinTypeMap = {
					'åŒå‘': 'BI',
					'åœ°': 'GROUND',
					'é«˜é˜»': 'HIZ',
					'è¾“å…¥': 'IN',
					'å¼€é›†ç”µæ': 'OPEN_COLLECTOR',
					'å¼€å‘å°„æ': 'OPEN_EMITTER',
					'è¾“å‡º': 'OUT',
					'æ— æº': 'PASSIVE',
					'ç”µæº': 'POWER',
					'ä¿¡å·ç»ˆç«¯': 'TERMINATOR',
					'æœªå®šä¹‰': 'UNDEFINED'
				};
				
				return pinTypeMap[chineseType] || 'UNDEFINED';
			}

			/**
			 * åˆ›å»ºç¬¦å·å¼•è„š
			 */
			function createSymbolPins(pins, bbox, type) {
				if (!Array.isArray(pins) || pins.length === 0) {
					throw new Error('æ— æ•ˆçš„å¼•è„šæ•°æ®: ' + pins);
				}

				if (!Array.isArray(bbox) || bbox.length < 8 || bbox.some((value) => isNaN(value))) {
					throw new Error('æ— æ•ˆçš„è¾¹æ¡†æ•°æ®: ' + bbox);
				}
				console.log('type1', type);
				pins.forEach((pin, pinIndex) => {
						const pinNumber = pin.pinNumber;
						const pinName = pin.pinName;
						const pinType = mapPinType(pin.pinType || 'æœªå®šä¹‰'); // æ˜ å°„å¼•è„šç±»å‹
						console.log('type2', type);
						let x = 0,
							y = 0,
							rotation = 0; // æ—‹è½¬è§’åº¦
						const pinCount = pins.length;

					if (type === 'DUAL_SIDE') {
						// å·¦å³ä¸¤è¾¹å¸ƒå±€ï¼Œå·¦ä¸Šè§’ä¸ºç¬¬ä¸€ä¸ªå¼•è„šé€†æ—¶é’ˆæ’åˆ—
						const pinsPerSide = Math.ceil(pinCount / 2);
						
						if (pinIndex < pinsPerSide) {
							// å·¦è¾¹å¼•è„šï¼šä»ä¸Šåˆ°ä¸‹æ’åˆ—
							x = bbox[0] - 20; // å‘å·¦ç§»åŠ¨20
							// ä»é¡¶éƒ¨å¼€å§‹ï¼Œå‡åŒ€åˆ†å¸ƒ
							const yPosition = (pinIndex + 1) / (pinsPerSide + 1);
							y = bbox[1] + (bbox[5] - bbox[1]) * yPosition;
							rotation = 180; // å¼•è„šå‘å·¦
						} else {
							// å³è¾¹å¼•è„šï¼šä»ä¸‹åˆ°ä¸Šæ’åˆ—ï¼ˆé€†æ—¶é’ˆï¼‰
							x = bbox[2] + 20; // å‘å³ç§»åŠ¨20
							const rightPinIndex = pinIndex - pinsPerSide;
							const rightPinsCount = pinCount - pinsPerSide;
							// ä»åº•éƒ¨å¼€å§‹ï¼Œå‘ä¸Šæ’åˆ—
							const yPosition = 1 - (rightPinIndex + 1) / (rightPinsCount + 1);
							y = bbox[1] + (bbox[5] - bbox[1]) * yPosition;
							rotation = 0; // å¼•è„šå‘å³
						}
					} else {
						// åŸæœ‰çš„å››è¾¹å¸ƒå±€é€»è¾‘
						const sidePinCount =
							type === 'SOP'
								? Math.ceil(pinCount / 2) // å¦‚æœæ˜¯ SOP ç±»å‹ï¼Œæ¯è¾¹åˆ†é…ä¸€åŠå¼•è„š
								: Math.ceil((pinCount + 4) / 4) - 1; // å…¶ä»–ç±»å‹ï¼Œæ¯è¾¹åˆ†é…å¼•è„šæ•°é‡ï¼ˆå»æ‰é¡¶ç‚¹ï¼‰

						const side =
							type === 'SOP'
								? pinIndex < sidePinCount
									? 0
									: 2 // å¦‚æœæ˜¯ SOP ç±»å‹ï¼Œåªä½¿ç”¨å·¦è¾¹(0)å’Œå³è¾¹(2)
								: Math.floor(pinIndex / sidePinCount); // å…¶ä»–ç±»å‹ï¼ŒæŒ‰å››è¾¹åˆ†é…

						const index =
							type === 'SOP'
								? pinIndex % sidePinCount // å¦‚æœæ˜¯ SOP ç±»å‹ï¼ŒæŒ‰å·¦å³ä¸¤è¾¹åˆ†é…
								: pinIndex % sidePinCount; // å…¶ä»–ç±»å‹ï¼ŒæŒ‰å››è¾¹åˆ†é…

						const normalizedIndex = sidePinCount > 1 ? (index + 1) / (sidePinCount + 1) : 0;
						console.log('type3', type);
						switch (side) {
							case 0: // left (é€†æ—¶é’ˆç¬¬1è¾¹)
								x = bbox[0] - 20; // å‘å·¦ç§»åŠ¨20
								y = bbox[5] - (bbox[5] - bbox[1]) * normalizedIndex;
								rotation = 180; // æ—‹è½¬è§’åº¦180
								break;
							case 1: // bottom (é€†æ—¶é’ˆç¬¬2è¾¹)
								if (type !== 'SOP') {
									// SOP ç±»å‹ä¸åˆ›å»ºåº•è¾¹å¼•è„š
									x = bbox[0] + (bbox[2] - bbox[0]) * normalizedIndex; // æ²¿ç€åº•è¾¹ä»å·¦åˆ°å³
									y = bbox[1] - 20; // å‘ä¸Šç§»åŠ¨20
									rotation = 270; // æ—‹è½¬è§’åº¦270
								}
								break;
							case 2: // right (é€†æ—¶é’ˆç¬¬3è¾¹)
								x = bbox[2] + 20; // å‘å³ç§»åŠ¨20
								y = bbox[1] + (bbox[5] - bbox[1]) * normalizedIndex;
								rotation = 0; // æ—‹è½¬è§’åº¦0
								break;
							case 3: // top (é€†æ—¶é’ˆç¬¬4è¾¹)
								if (type !== 'SOP') {
									// SOP ç±»å‹ä¸åˆ›å»ºé¡¶è¾¹å¼•è„š
									x = bbox[2] - (bbox[2] - bbox[0]) * normalizedIndex; // æ²¿ç€é¡¶è¾¹ä»å³åˆ°å·¦
									y = bbox[5] + 20; // å‘ä¸‹ç§»åŠ¨20
									rotation = 90; // æ—‹è½¬è§’åº¦90
								}
								break;
						}
					}

					if (isNaN(x) || isNaN(y)) {
							throw new Error(`å¼•è„šåæ ‡æ— æ•ˆ: pinNumber=${pinNumber}, pinName=${pinName}, x=${x}, y=${y}`);
						}

						console.log('åˆ›å»ºå¼•è„š:', pinNumber, pinName, x, y, rotation, pinType);
						eda.sch_PrimitivePin.create(x, y, pinNumber, pinName, rotation, undefined, undefined, undefined, pinType);
				});
			}

			/**
			 * åˆå§‹åŒ–å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
			 */
			function initImagePreview() {
				const imagePreviewModal = document.getElementById('image-preview-modal');
				const previewImage = document.getElementById('preview-image');
				const previewInfo = document.getElementById('preview-info');
				const closePreviewBtn = document.getElementById('close-preview');

				// å…³é—­é¢„è§ˆ
				function closePreview() {
					imagePreviewModal.style.display = 'none';
					previewImage.src = '';
				}

				// ç‚¹å‡»å…³é—­æŒ‰é’®
				closePreviewBtn.addEventListener('click', closePreview);

				// ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
				imagePreviewModal.addEventListener('click', (e) => {
					if (e.target === imagePreviewModal) {
						closePreview();
					}
				});

				// ESCé”®å…³é—­
				document.addEventListener('keydown', (e) => {
					if (e.key === 'Escape' && imagePreviewModal.style.display === 'flex') {
						closePreview();
					}
				});

				// ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»é¢„è§ˆåŠŸèƒ½
				function addImageClickPreview() {
					const currentImage = document.getElementById('current-image');
					if (currentImage && currentImages.length > 0) {
						// ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
						const newImage = currentImage.cloneNode(true);
						currentImage.parentNode.replaceChild(newImage, currentImage);
						
						// é‡æ–°è·å–æ–°çš„å›¾ç‰‡å…ƒç´ 
						const freshImage = document.getElementById('current-image');
						freshImage.style.cursor = 'pointer';
						freshImage.style.pointerEvents = 'auto';
						
						freshImage.addEventListener('click', (e) => {
							// é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ¡†é€‰åŠŸèƒ½
							e.stopPropagation();
							
							// å¦‚æœæ­£åœ¨æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ï¼Œä¸è§¦å‘é¢„è§ˆ
							if (manualSelectionMode) {
								return;
							}

							// æ˜¾ç¤ºé¢„è§ˆ
							const currentImageData = currentImages[currentImageIndex];
							previewImage.src = currentImageData.src;
							previewInfo.textContent = currentImageData.name || `é¡µé¢ ${currentImageIndex + 1}`;
							imagePreviewModal.style.display = 'flex';
						});
					}
				}

				// ç›‘å¬å›¾ç‰‡æ˜¾ç¤ºæ›´æ–°ï¼Œä¸ºæ–°å›¾ç‰‡æ·»åŠ é¢„è§ˆåŠŸèƒ½
				const originalDisplayCurrentImage = displayCurrentImage;
				displayCurrentImage = function() {
					originalDisplayCurrentImage.apply(this, arguments);
					// å»¶è¿Ÿæ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿å›¾ç‰‡å·²ç»åŠ è½½
					setTimeout(addImageClickPreview, 100);
				};
			}
		</script>
	</body>
</html>
